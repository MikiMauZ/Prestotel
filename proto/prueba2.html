<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Prestotel - Sistema de Gestión Hotelera</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f4f6f8;
      color: #333;
    }

    /* Estilos de Login */
    .login-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background-color: #f4f6f8;
      padding: 20px;
    }
    .login-box {
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 400px;
      padding: 30px;
    }
    .login-logo {
      text-align: center;
      margin-bottom: 30px;
    }
    .login-logo img {
      height: 60px;
    }
    .login-field {
      margin-bottom: 20px;
    }
    .login-field label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #555;
    }
    .login-field input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
    }
    .login-btn {
      width: 100%;
      background-color: #3b6aaf;
      color: white;
      border: none;
      padding: 12px;
      border-radius: 4px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .login-btn:hover {
      background-color: #325a96;
    }
    .login-error {
      color: #e74c3c;
      margin-top: 15px;
      text-align: center;
    }

    /* Estilos de la Topbar */
    .topbar {
      background-color: #f0f0f0;
      border-bottom: 1px solid #ddd;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0;
    }
    .menu-btn {
      padding: 15px;
      display: flex;
      align-items: center;
      color: #666;
      font-size: 1rem;
      cursor: pointer;
      border-right: 1px solid #ddd;
    }
    .menu-btn i {
      margin-left: 5px;
    }
    .logo {
      padding: 10px 15px;
      display: flex;
      align-items: center;
    }
    .logo-text {
      font-size: 1.2rem;
      font-weight: bold;
    }
    .logo-text span:first-child {
      color: #3b6aaf;
    }
    .logo-text span:last-child {
      color: #888;
    }
    .user-actions {
      display: flex;
    }
    .action-btn {
      width: 50px;
      height: 50px;
      display: flex;
      justify-content: center;
      align-items: center;
      color: #666;
      font-size: 1.1rem;
      border-left: 1px solid #ddd;
      cursor: pointer;
    }
    /* Estilos del Menú */
    .menu-container {
      position: fixed;
      top: 50px;
      left: 0;
      width: 100%;
      height: calc(100vh - 50px);
      background-color: #f0f0f0;
      z-index: 100;
      transform: translateX(-100%);
      transition: transform 0.3s;
      overflow-y: auto;
    }
    .menu-container.open {
      transform: translateX(0);
    }
    .menu-header {
      padding: 15px;
      color: #666;
      font-size: 1rem;
      border-bottom: 1px solid #ddd;
    }
    .menu-modules {
      padding: 0;
    }
    .module-item {
      display: flex;
      align-items: center;
      padding: 15px;
      border-bottom: 1px solid #ddd;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .module-item:hover {
      background-color: #e8e8e8;
    }
    .module-icon {
      width: 40px;
      height: 40px;
      background-color: #333;
      color: white;
      display: flex;
      justify-content: center;
      align-items: center;
      margin-right: 15px;
      font-size: 1.2rem;
    }
    .module-text {
      color: #555;
      font-size: 1rem;
    }

    /* Estilos de contenido principal */
    .content {
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }
    .content-header {
      margin-bottom: 20px;
    }
    .content-title {
      font-size: 1.5rem;
      font-weight: 500;
      color: #333;
      margin-bottom: 5px;
    }
    .content-subtitle {
      color: #777;
      font-size: 0.9rem;
    }

    /* Estilos de los formularios */
    .form-container {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      padding: 20px;
      margin-bottom: 20px;
    }
    .form-title {
      font-size: 1.1rem;
      font-weight: 500;
      margin-bottom: 15px;
      color: #333;
    }
    .form-row {
      display: flex;
      flex-wrap: wrap;
      margin: 0 -10px;
    }
    .form-group {
      padding: 0 10px;
      margin-bottom: 15px;
      flex: 1 0 100%;
    }
    @media (min-width: 768px) {
      .form-group.half {
        flex: 0 0 50%;
      }
      .form-group.third {
        flex: 0 0 33.33%;
      }
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: #555;
      font-size: 0.9rem;
    }
    .form-control {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 0.95rem;
    }
    textarea.form-control {
      min-height: 100px;
      resize: vertical;
    }
    .btn {
      background-color: #3b6aaf;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.95rem;
      transition: background-color 0.2s;
    }
    .btn:hover {
      background-color: #325a96;
    }
    .btn-danger {
      background-color: #e74c3c;
    }
    .btn-danger:hover {
      background-color: #c0392b;
    }
    .btn-warning {
      background-color: #f39c12;
    }
    .btn-warning:hover {
      background-color: #d35400;
    }
    .btn-success {
      background-color: #27ae60;
    }
    .btn-success:hover {
      background-color: #219653;
    }

    /* Estilos de las tablas y tarjetas */
    .data-container {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      overflow: hidden;
    }
    .filter-bar {
      padding: 15px;
      border-bottom: 1px solid #eee;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .filter-group {
      display: flex;
      align-items: center;
    }
    .filter-label {
      margin-right: 8px;
      font-size: 0.9rem;
      color: #555;
    }
    .filter-select {
      padding: 6px 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 0.9rem;
    }
    .card-container {
      padding: 15px;
    }
    .task-card {
      border: 1px solid #eee;
      border-radius: 6px;
      padding: 15px;
      margin-bottom: 15px;
      background-color: #fff;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    .task-card:last-child {
      margin-bottom: 0;
    }
    .task-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 10px;
    }
    .task-title {
      font-weight: 500;
      font-size: 1.1rem;
      color: #333;
      margin: 0;
    }
    .task-meta {
      display: flex;
      font-size: 0.85rem;
      margin-bottom: 5px;
    }
    .task-hotel, .task-area, .task-date {
      color: #666;
      margin-right: 15px;
    }
    .task-priority {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
      color: white;
      font-weight: 500;
    }
    .priority-alta {
      background-color: #e74c3c;
    }
    .priority-media {
      background-color: #f39c12;
    }
    .priority-baja {
      background-color: #27ae60;
    }
    .task-description {
      color: #555;
      font-size: 0.95rem;
      margin-bottom: 15px;
    }
    .task-cost {
      color: #3b6aaf;
      font-weight: 500;
      font-size: 1rem;
      margin-bottom: 15px;
    }
    .task-actions {
      display: flex;
      gap: 10px;
    }

    /* Estilos para stock y pedidos (inicialmente ocultos) */
    .module-content {
      display: none;
    }
    .module-content.active {
      display: block;
    }

    /* Stock específico */
    .stock-item {
      display: flex;
      flex-wrap: wrap;
      border-bottom: 1px solid #eee;
      padding: 10px 0;
    }
    .stock-item:last-child {
      border-bottom: none;
    }
    .stock-name {
      flex: 2;
      padding: 5px;
      font-weight: 500;
    }
    .stock-quantity {
      flex: 1;
      padding: 5px;
      text-align: center;
    }
    .stock-actions {
      flex: 1;
      padding: 5px;
      text-align: right;
    }
    .stock-level-low {
      color: #e74c3c;
    }
    .stock-level-medium {
      color: #f39c12;
    }
    .stock-level-good {
      color: #27ae60;
    }

    /* Pedidos específico */
    .order-status {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
      color: white;
      font-weight: 500;
    }
    .status-pendiente {
      background-color: #ff9800; /* naranja */
    }
    .status-solicitado {
      background-color: #2196f3; /* azul */
    }
    .status-completado {
      background-color: #4caf50; /* verde */
    }
    .status-rechazado {
      background-color: #f44336; /* rojo */
    }

    /* Utilidades */
    .text-right {
      text-align: right;
    }
    .spacer {
      flex: 1;
    }
    .hidden {
      display: none;
    }
    .admin-only {
      display: none;
    }
    .is-admin .admin-only {
      display: block;
    }

    /* Mejoras visuales generales */
    .topbar {
      background-color: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .logo-text span:first-child {
      color: #3b6aaf;
      font-weight: 600;
    }

    .form-container, .data-container {
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      margin-bottom: 25px;
      border: none;
    }

    .task-card {
      transition: transform 0.2s, box-shadow 0.2s;
      border-left: 4px solid #ddd;
    }

    .task-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .btn {
      border-radius: 4px;
      font-weight: 500;
      padding: 8px 16px;
      transition: background-color 0.2s, transform 0.1s;
    }

    .btn:hover {
      transform: translateY(-1px);
    }

    .btn-primary {
      background-color: #2196f3;
      color: white;
    }

    .btn-primary:hover {
      background-color: #1976d2;
    }

    /* Estilos para el diálogo de rechazo */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal-container {
      background-color: white;
      border-radius: 8px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .modal-header {
      padding: 15px 20px;
      border-bottom: 1px solid #ddd;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-body {
      padding: 20px;
    }

    .modal-footer {
      padding: 15px 20px;
      border-top: 1px solid #ddd;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .close-modal {
      cursor: pointer;
      font-size: 1.2rem;
      color: #999;
    }

    .reject-reason {
      margin-top: 10px;
      padding: 10px;
      background-color: #ffebee;
      border-radius: 4px;
      font-size: 0.9rem;
    }

    /* Estilos mejorados para pedidos químicos */
.chemical-table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 15px;
  font-size: 0.9rem;
}

.chemical-table th,
.chemical-table td {
  padding: 8px;
  border: 1px solid #e0e0e0;
  text-align: left;
}

.chemical-table th {
  background-color: #f8f9fa;
  font-weight: 500;
  color: #555;
}

.chemical-table input[type="number"] {
  width: 60px;
  padding: 6px;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 0.9rem;
}

.table-responsive {
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}

.product-col {
  width: 50%;
}

.qty-col {
  width: 20%;
}

.unit-col {
  width: 10%;
}

/* Lista de productos en tarjetas de pedido */
.chemical-product-item {
  display: flex;
  justify-content: space-between;
  padding: 4px 0;
  border-bottom: 1px solid #f0f0f0;
  font-size: 0.9rem;
}

.chemical-product-item:last-child {
  border-bottom: none;
}

.product-name {
  font-weight: 500;
}

.product-qty {
  color: #666;
}

/* Mejoras responsivas para móviles */
@media (max-width: 768px) {
  .chemical-table {
    font-size: 0.8rem;
  }
  
  .chemical-table th,
  .chemical-table td {
    padding: 6px 4px;
  }
  
  .chemical-table input[type="number"] {
    width: 50px;
    padding: 4px;
    font-size: 0.8rem;
  }
  
  .chemical-product-item {
    flex-direction: column;
    padding: 6px 0;
  }
  
  .product-qty {
    margin-top: 2px;
  }
}

/* Para pantallas muy pequeñas */
@media (max-width: 480px) {
  .product-col {
    min-width: 120px;
  }
  
  .qty-col {
    min-width: 80px;
  }
  
  .unit-col {
    min-width: 40px;
  }
}

/* Mejoras generales para responsive design */
@media (max-width: 768px) {
  .form-container, .data-container {
    padding: 15px;
  }
  
  .content-title {
    font-size: 1.3rem;
  }
  
  .content-subtitle {
    font-size: 0.85rem;
  }
  
  .form-title {
    font-size: 1rem;
  }
  
  .form-control {
    font-size: 0.9rem;
    padding: 6px 8px;
  }
  
  .btn {
    font-size: 0.85rem;
    padding: 6px 12px;
  }
  
  .filter-bar {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .filter-group {
    margin-bottom: 8px;
    width: 100%;
  }
  
  .filter-select {
    width: 100%;
  }
  
  /* Arreglar espaciado en los botones de acciones en móvil */
  .task-actions {
    flex-wrap: wrap;
    gap: 8px;
  }
  
  .task-actions .btn {
    margin-bottom: 5px;
  }
}

/* Para pantallas muy pequeñas */
@media (max-width: 480px) {
  .form-group.half {
    flex: 0 0 100%;
  }
  
  .form-group.third {
    flex: 0 0 100%;
  }
  
  .task-meta {
    flex-direction: column;
  }
  
  .task-hotel, .task-area, .task-date, .task-supplier {
    margin-bottom: 5px;
  }
}

.logo {
  display: flex;
  flex-direction: column;
  justify-content: center;
  padding: 10px 15px;
  flex: 1;
}

.logo-text {
  font-size: 1.4rem;
  font-weight: bold;
  margin-bottom: 2px;
}

.logo-text span {
  color: #3b6aaf;
}

.logo-subtitle {
  font-size: 0.8rem;
  color: #666;
  font-style: italic;
}

/* Ajustes para móviles */
@media (max-width: 480px) {
  .logo-text {
    font-size: 1.2rem;
  }
  
  .logo-subtitle {
    font-size: 0.7rem;
  }
}

.calendar-navigation {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  background-color: #f5f5f5;
  padding: 10px 15px;
  border-radius: 4px;
}

#currentWeekDisplay {
  font-weight: 500;
  font-size: 1.1rem;
  color: #333;
}

.schedule-table-container {
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}

.schedule-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.9rem;
}

.schedule-table th,
.schedule-table td {
  border: 1px solid #ddd;
  padding: 8px;
  text-align: center;
}

.schedule-table th {
  background-color: #f8f8f8;
  font-weight: 500;
}

.schedule-table .employee-col {
  text-align: left;
  min-width: 150px;
}

.schedule-table .day-col {
  min-width: 120px;
}

.schedule-table .weekend {
  background-color: #f8f8f8;
}

.date-row th {
  font-size: 0.8rem;
  font-weight: normal;
  color: #666;
  padding: 4px 8px;
}

.shift {
  padding: 8px;
  border-radius: 4px;
  font-size: 0.85rem;
  cursor: pointer;
  transition: transform 0.1s;
}

.shift:hover {
  transform: scale(1.05);
}

.shift-morning {
  background-color: #D6EAF8;
  color: #1976D2;
  border: 1px solid #BBDEFB;
}

.shift-afternoon {
  background-color: #FCF3CF;
  color: #F57F17;
  border: 1px solid #FFF176;
}

.shift-night {
  background-color: #D5D8DC;
  color: #37474F;
  border: 1px solid #B0BEC5;
}

.shift-off {
  background-color: #EAEDED;
  color: #7B7D7D;
  border: 1px solid #D5DBDB;
}

.shift-vacation {
  background-color: #D5F5E3;
  color: #27AE60;
  border: 1px solid #A9DFBF;
}

.action-buttons {
  margin-top: 20px;
  display: flex;
  gap: 10px;
}

/* Adaptaciones responsive */
@media (max-width: 768px) {
  .calendar-navigation {
    flex-direction: column;
    gap: 10px;
    align-items: stretch;
  }
  
  #currentWeekDisplay {
    order: -1;
    text-align: center;
    margin-bottom: 10px;
  }
  
  .schedule-table .employee-col {
    min-width: 120px;
  }
  
  .schedule-table .day-col {
    min-width: 80px;
  }
  
  .shift {
    padding: 6px 4px;
    font-size: 0.8rem;
  }
}

/* Estilos para la gestión de personal */
.tabs-container {
  display: flex;
  background-color: #f8f9fa;
  border-radius: 8px 8px 0 0;
  overflow: hidden;
  margin-bottom: 20px;
}

.tab {
  padding: 15px 20px;
  cursor: pointer;
  transition: background-color 0.2s;
  font-weight: 500;
  display: flex;
  align-items: center;
  gap: 8px;
}

.tab i {
  font-size: 1.1rem;
}

.tab:hover {
  background-color: #e9ecef;
}

.tab.active {
  background-color: #3b6aaf;
  color: white;
}

.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
}

/* Tarjetas de empleado */
.employee-card {
  display: flex;
  flex-direction: column;
  border-left: 4px solid #3b6aaf;
}

.employee-header {
  display: flex;
  justify-content: space-between;
}

.employee-name {
  font-size: 1.1rem;
  font-weight: 500;
  color: #333;
}

.employee-position {
  font-size: 0.9rem;
  color: #666;
  margin-top: 2px;
}

.employee-dept {
  background-color: #e9ecef;
  border-radius: 4px;
  padding: 4px 8px;
  font-size: 0.8rem;
  color: #495057;
  display: inline-block;
}

.employee-details {
  margin: 10px 0;
  display: flex;
  flex-wrap: wrap;
  gap: 15px;
}

.employee-detail {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 0.9rem;
  color: #495057;
}

.employee-detail i {
  color: #6c757d;
}

.employee-actions {
  margin-top: 10px;
  display: flex;
  gap: 10px;
}

/* Tarjetas de usuario */
.user-card {
  display: flex;
  border-left: 4px solid #2196f3;
}

.user-info {
  flex: 1;
}

.user-email {
  font-size: 1.1rem;
  font-weight: 500;
  color: #333;
}

.user-role {
  display: inline-block;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 0.8rem;
  margin-top: 5px;
}

.role-admin {
  background-color: #d1e7ff;
  color: #0d47a1;
}

.role-user {
  background-color: #e8f5e9;
  color: #1b5e20;
}

.user-created {
  margin-top: 10px;
  font-size: 0.85rem;
  color: #6c757d;
}

.user-employee {
  margin-top: 5px;
  font-size: 0.9rem;
  color: #495057;
}

.user-actions {
  display: flex;
  flex-direction: column;
  gap: 8px;
  justify-content: center;
  padding-left: 15px;
}

/* Tabla de actividad */
.activity-table {
  width: 100%;
  border-collapse: collapse;
}

.activity-table th,
.activity-table td {
  padding: 12px 15px;
  text-align: left;
  border-bottom: 1px solid #e9ecef;
}

.activity-table th {
  background-color: #f8f9fa;
  font-weight: 500;
  color: #495057;
}

.activity-table tr:hover {
  background-color: #f8f9fa;
}

.activity-timestamp {
  font-family: monospace;
  white-space: nowrap;
}

.activity-user {
  color: #3b6aaf;
  font-weight: 500;
}

.activity-action {
  font-weight: 500;
}

.activity-type-login {
  color: #6c757d;
}

.activity-type-task {
  color: #fd7e14;
}

.activity-type-order {
  color: #20c997;
}

.activity-type-chemical {
  color: #6f42c1;
}

.activity-type-shift {
  color: #6610f2;
}

.activity-type-employee {
  color: #0d6efd;
}

.activity-details {
  color: #495057;
  font-size: 0.9rem;
}

/* Responsive */
@media (max-width: 768px) {
  .tabs-container {
    flex-direction: column;
  }
  
  .user-card {
    flex-direction: column;
  }
  
  .user-actions {
    flex-direction: row;
    padding-left: 0;
    margin-top: 10px;
  }
  
  .activity-table th:nth-child(4),
  .activity-table td:nth-child(4) {
    display: none;
  }
}
    </style>
    </head>
    <body>
      <!-- Pantalla de Login -->
      <div id="loginScreen" class="login-container">
        <div class="login-box">
          <div class="login-logo">
            <div class="logo-text">
              <span>Prestotel</span><span> HOTEL</span>
            </div>
          </div>
          <div class="login-field">
            <label for="email">Correo electrónico</label>
            <input type="email" id="email" placeholder="correo@ejemplo.com">
          </div>
          <div class="login-field">
            <label for="password">Contraseña</label>
            <input type="password" id="password" placeholder="Contraseña">
          </div>
          <button id="loginBtn" class="login-btn">Iniciar Sesión</button>
          <div id="loginError" class="login-error"></div>
        </div>
      </div>


      <!-- Aplicación Principal (inicialmente oculta) -->
      <div id="appScreen" class="hidden">
        <!-- Barra superior -->
        <div class="topbar">
          <div class="menu-btn" id="menuBtn">
            Menú <i class="fas fa-chevron-right"></i>
          </div>
          <div class="logo">
            <div class="logo-text">
              <span>Presto  </span>
            </div>

            <div class="logo-subtitle">  Gestión técnica sin complicaciones</div>
          </div>
        </div>

        <!-- Menú lateral -->
        <div class="menu-container" id="menuContainer">
          <div class="menu-header"></div>
          <div class="menu-modules">
            
            <div class="module-item" data-module="personal">
              <div class="module-icon"><i class="fas fa-users"></i></div>
              <div class="module-text">Personal</div>
            </div>
            <div class="module-item" data-module="mejoras">
              <div class="module-icon"><i class="fas fa-tasks"></i></div>
              <div class="module-text">Mejoras de Invierno</div>
            </div>
            <div class="module-item" data-module="stock">
              <div class="module-icon"><i class="fas fa-boxes"></i></div>
              <div class="module-text">Inventario / Stock</div>
            </div>
            <div class="module-item" data-module="pedidos">
              <div class="module-icon"><i class="fas fa-shopping-cart"></i></div>
              <div class="module-text">Pedidos</div>
            </div>

            <div class="module-item" data-module="quimicos">
              <div class="module-icon"><i class="fas fa-flask"></i></div>
              <div class="module-text">Pedidos Químicos</div>
            </div>


            <div class="module-item" data-module="turnos">
              <div class="module-icon"><i class="fas fa-calendar-alt"></i></div>
              <div class="module-text">Turnos de Personal</div>
            </div>

            <div class="module-item" id="logoutBtn">
              <div class="module-icon" style="background-color: #e74c3c;">
                <i class="fas fa-sign-out-alt"></i>
              </div>
              <div class="module-text">Cerrar Sesión</div>
            </div>
          </div>
        </div>

        <!-- Contenido principal -->
        <div class="content">

          <!-- Módulo de Mejoras -->
          <div id="mejorasModule" class="module-content active">
            <div class="content-header">
              <h1 class="content-title">Mejoras de Invierno</h1>
              <div class="content-subtitle">Gestión de tareas de mejora para el cierre de temporada</div>
            </div>

            <!-- Formulario de nueva tarea -->
            <div class="form-container">
              <h2 class="form-title">Nueva tarea de mejora</h2>
              <div class="form-row">
                <div class="form-group">
                  <label for="taskTitle">Título</label>
                  <input type="text" id="taskTitle" class="form-control" placeholder="Título de la tarea">
                </div>
              </div>
              <div class="form-row">
                <div class="form-group half">
                  <label for="taskHotel">Hotel</label>
                  <select id="taskHotel" class="form-control">
                    <option value="Wave">Wave</option>
                    <option value="Sky">Sky</option>
                    <option value="Palm">Palm</option>
                  </select>
                </div>
                <div class="form-group half">
                  <label for="taskArea">Área</label>
                  <select id="taskArea" class="form-control">
                    <option value="Recepción">Recepción</option>
                    <option value="Habitaciones">Habitaciones</option>
                    <option value="Restaurante">Restaurante</option>
                    <option value="Cocina">Cocina</option>
                    <option value="Exterior">Exterior</option>
                    <option value="Piscina">Piscina</option>
                    <option value="Baños">Baños</option>
                    <option value="Zonas Técnicas">Zonas Técnicas</option>
                    <option value="Gimnasio">Gimnasio</option>
                    <option value="Bar">Bar</option>
                    <option value="Zonas Comunes">Zonas Comunes</option>
                    <option value="Sótano">Sótano</option>
                    <option value="Otra">Otra</option>
                  </select>
                </div>
              </div>
              <div class="form-row">
                <div class="form-group half">
                  <label for="taskPriority">Prioridad</label>
                  <select id="taskPriority" class="form-control">
                    <option value="Alta">Alta</option>
                    <option value="Media" selected>Media</option>
                    <option value="Baja">Baja</option>
                  </select>
                </div>
                <div class="form-group half">
                  <label for="taskCost">Coste estimado (€)</label>
                  <input type="number" id="taskCost" class="form-control" placeholder="0">
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label for="taskDescription">Descripción</label>
                  <textarea id="taskDescription" class="form-control" placeholder="Describe la tarea..."></textarea>
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <button id="saveTask" class="btn">Guardar Tarea</button>
                </div>
              </div>
            </div>

            <!-- Lista de tareas -->
            <div class="data-container">
              <div class="filter-bar">
                <div class="filter-group">
                  <span class="filter-label">Hotel:</span>
                  <select id="filterHotel" class="filter-select">
                    <option value="">Todos</option>
                    <option value="Wave">Wave</option>
                    <option value="Sky">Sky</option>
                    <option value="Palm">Palm</option>
                  </select>
                </div>
                <div class="filter-group">
                  <span class="filter-label">Área:</span>
                  <select id="filterArea" class="filter-select">
                    <option value="">Todas</option>
                    <option value="Recepción">Recepción</option>
                    <option value="Habitaciones">Habitaciones</option>
                    <option value="Restaurante">Restaurante</option>
                    <option value="Cocina">Cocina</option>
                    <option value="Exterior">Exterior</option>
                    <option value="Piscina">Piscina</option>
                    <option value="Baños">Baños</option>
                    <option value="Zonas Técnicas">Zonas Técnicas</option>
                    <option value="Gimnasio">Gimnasio</option>
                    <option value="Bar">Bar</option>
                    <option value="Zonas Comunes">Zonas Comunes</option>
                    <option value="Sótano">Sótano</option>
                    <option value="Otra">Otra</option>
                  </select>
                </div>
                <div class="filter-group">
                  <span class="filter-label">Prioridad:</span>
                  <select id="filterPriority" class="filter-select">
                    <option value="">Todas</option>
                    <option value="Alta">Alta</option>
                    <option value="Media">Media</option>
                    <option value="Baja">Baja</option>
                  </select>
                </div>
                <div class="spacer"></div>
                <button id="clearFilters" class="btn">Limpiar</button>
                <button id="exportExcel" class="btn btn-success">
                  <i class="fas fa-file-excel"></i> Exportar
                </button>
              </div>
              <div id="taskContainer" class="card-container">
                <!-- Las tareas se cargarán aquí dinámicamente -->
              </div>
            </div>
          </div>

          
          <!-- Módulo de Stock/Inventario -->
          <div id="stockModule" class="module-content">
            <div class="content-header">
              <h1 class="content-title">Inventario / Stock</h1>
              <div class="content-subtitle">Control de stock y materiales</div>
            </div>

            <!-- Formulario de nuevo ítem de stock -->
            <div class="form-container">
              <h2 class="form-title">Nuevo ítem de inventario</h2>
              <div class="form-row">
                <div class="form-group half">
                  <label for="stockName">Nombre del producto</label>
                  <input type="text" id="stockName" class="form-control" placeholder="Nombre del producto">
                </div>
                <div class="form-group half">
                  <label for="stockCategory">Categoría</label>
                  <select id="stockCategory" class="form-control">
                    <option value="Limpieza">Limpieza</option>
                    <option value="Mantenimiento">Mantenimiento</option>
                    <option value="Cocina">Cocina</option>
                    <option value="Habitaciones">Habitaciones</option>
                    <option value="Piscina">Piscina</option>
                    <option value="Oficina">Oficina</option>
                    <option value="Otra">Otra</option>
                  </select>
                </div>
              </div>
              <div class="form-row">
                <div class="form-group third">
                  <label for="stockQuantity">Cantidad</label>
                  <input type="number" id="stockQuantity" class="form-control" placeholder="0">
                </div>
                <div class="form-group third">
                  <label for="stockMinimum">Cantidad mínima</label>
                  <input type="number" id="stockMinimum" class="form-control" placeholder="0">
                </div>
                <div class="form-group third">
                  <label for="stockUnit">Unidad</label>
                  <select id="stockUnit" class="form-control">
                    <option value="Unidades">Unidades</option>
                    <option value="Cajas">Cajas</option>
                    <option value="Kg">Kg</option>
                    <option value="Litros">Litros</option>
                    <option value="Metros">Metros</option>
                    <option value="Paquetes">Paquetes</option>
                  </select>
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label for="stockNotes">Notas</label>
                  <textarea id="stockNotes" class="form-control" placeholder="Notas adicionales..."></textarea>
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <button id="saveStock" class="btn">Guardar Producto</button>
                </div>
              </div>
            </div>

            <!-- Lista de stock -->
            <div class="data-container">
              <div class="filter-bar">
                <div class="filter-group">
                  <span class="filter-label">Categoría:</span>
                  <select id="filterStockCategory" class="filter-select">
                    <option value="">Todas</option>
                    <option value="Limpieza">Limpieza</option>
                    <option value="Mantenimiento">Mantenimiento</option>
                    <option value="Cocina">Cocina</option>
                    <option value="Habitaciones">Habitaciones</option>
                    <option value="Piscina">Piscina</option>
                    <option value="Oficina">Oficina</option>
                    <option value="Otra">Otra</option>
                  </select>
                </div>
                <div class="filter-group">
                  <span class="filter-label">Stock:</span>
                  <select id="filterStockLevel" class="filter-select">
                    <option value="">Todos</option>
                    <option value="low">Bajo mínimo</option>
                    <option value="medium">Regular</option>
                    <option value="good">Adecuado</option>
                  </select>
                </div>
                <div class="spacer"></div>
                <button id="clearStockFilters" class="btn">Limpiar</button>
                <button id="exportStockExcel" class="btn btn-success">
                  <i class="fas fa-file-excel"></i> Exportar
                </button>
              </div>
              <div id="stockContainer" class="card-container">
                <!-- Los ítems de stock se cargarán aquí dinámicamente -->
              </div>
            </div>
          </div>

          <!-- Módulo de Pedidos -->
          <div id="pedidosModule" class="module-content">
            <div class="content-header">
              <h1 class="content-title">Pedidos</h1>
              <div class="content-subtitle">Gestión de pedidos a proveedores</div>
            </div>

            <!-- Formulario de nuevo pedido -->
            <div class="form-container">
              <h2 class="form-title">Nuevo pedido</h2>
              <div class="form-row">
                <div class="form-group half">
                  <label for="orderTitle">Título del pedido</label>
                  <input type="text" id="orderTitle" class="form-control" placeholder="Título del pedido">
                </div>
                <div class="form-group half">
                  <label for="orderSupplier">Proveedor</label>
                  <input type="text" id="orderSupplier" class="form-control" placeholder="Nombre del proveedor">
                </div>
              </div>
              <div class="form-row">
                <div class="form-group half">
                  <label for="orderDate">Fecha necesaria</label>
                  <input type="date" id="orderDate" class="form-control">
                </div>
                <div class="form-group half">
                    <label for="orderAmount">Importe estimado (€)</label>
                    <input type="number" id="orderAmount" class="form-control" placeholder="0">
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <label for="orderItems">Elementos a pedir</label>
                    <textarea id="orderItems" class="form-control" placeholder="Detalle de los elementos a pedir..."></textarea>
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <button id="saveOrder" class="btn">Guardar Pedido</button>
                  </div>
                </div>
              </div>
  
              <!-- Lista de pedidos -->
              <div class="data-container">
                <div class="filter-bar">
                  <div class="filter-group">
                    <span class="filter-label">Estado:</span>
                    <select id="filterOrderStatus" class="filter-select">
                      <option value="">Todos</option>
  <option value="Pendiente">Pendiente</option>
  <option value="Solicitado">Solicitado</option>
  <option value="Completado">Completado</option>
  <option value="Rechazado">Rechazado</option>
                    </select>
                  </div>
                  <div class="filter-group">
                    <span class="filter-label">Proveedor:</span>
                    <select id="filterOrderSupplier" class="filter-select">
                      <option value="">Todos</option>
                      <!-- Se llenará dinámicamente -->
                    </select>
                  </div>
                  <div class="spacer"></div>
                  <button id="clearOrderFilters" class="btn">Limpiar</button>
                  <button id="exportOrderExcel" class="btn btn-success">
                    <i class="fas fa-file-excel"></i> Exportar
                  </button>
                </div>
                <div id="orderContainer" class="card-container">
                  <!-- Los pedidos se cargarán aquí dinámicamente -->
                </div>
              </div>
            </div> <!-- Fin del módulo de pedidos -->
          </div> <!-- Fin del contenido principal -->
        </div> <!-- Fin del appScreen -->


        <!-- Módulo de Pedidos Químicos -->
<div id="quimicosModule" class="module-content">
  <div class="content-header">
    <h1 class="content-title">Pedidos de Productos Químicos</h1>
    <div class="content-subtitle">Gestión de pedidos de químicos para piscinas</div>
  </div>

  <!-- Formulario de nuevo pedido de químicos -->
  <div class="form-container">
    <h2 class="form-title">Nuevo pedido de químicos</h2>
    <div class="form-row">
      <div class="form-group half">
        <label for="chemicalTitle">Título del pedido</label>
        <input type="text" id="chemicalTitle" class="form-control" placeholder="Ej: Productos químicos mayo 2025">
      </div>
      <div class="form-group half">
        <label for="chemicalHotel">Hotel</label>
        <select id="chemicalHotel" class="form-control">
          <option value="Wave">Wave</option>
          <option value="Sky">Sky</option>
          <option value="Ambos">Ambos hoteles</option>
        </select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Productos y cantidades</label>
        <div class="table-responsive">
          <table class="chemical-table">
            <thead>
              <tr>
                <th class="product-col">Producto</th>
                <th class="qty-col">Cantidad Wave</th>
                <th class="qty-col">Cantidad Sky</th>
                <th class="unit-col">Unidad</th>
              </tr>
            </thead>
            <tbody id="chemicalProductsList">
              <!-- Los productos se generarán dinámicamente aquí -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label for="chemicalNotes">Notas adicionales</label>
        <textarea id="chemicalNotes" class="form-control" placeholder="Notas adicionales sobre el pedido..."></textarea>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <button id="saveChemical" class="btn">Guardar Pedido</button>
        <button id="shareWhatsApp" class="btn btn-success">
          <i class="fab fa-whatsapp"></i> Compartir por WhatsApp
        </button>
      </div>
    </div>
  </div>

  <!-- Lista de pedidos químicos -->
  <div class="data-container">
    <div class="filter-bar">
      <div class="filter-group">
        <span class="filter-label">Hotel:</span>
        <select id="filterChemicalHotel" class="filter-select">
          <option value="">Todos</option>
          <option value="Wave">Wave</option>
          <option value="Sky">Sky</option>
          <option value="Ambos">Ambos hoteles</option>
        </select>
      </div>
      <div class="spacer"></div>
      <button id="clearChemicalFilters" class="btn">Limpiar</button>
      <button id="exportChemicalExcel" class="btn btn-success">
        <i class="fas fa-file-excel"></i> Exportar
      </button>
    </div>
    <div id="chemicalContainer" class="card-container">
      <!-- Los pedidos químicos se cargarán aquí dinámicamente -->
    </div>
  </div>
</div>

<!-- Módulo de Gestión de Personal (solo visible para admins) -->
<div id="personalModule" class="module-content admin-only">
  <div class="content-header">
    <h1 class="content-title">Gestión de Personal</h1>
    <div class="content-subtitle">Administración de empleados y usuarios del sistema</div>
  </div>

  <!-- Tabs para navegar entre secciones -->
  <div class="tabs-container">
    <div class="tab active" data-tab="empleados"><i class="fas fa-user-tie"></i> Empleados</div>
    <div class="tab" data-tab="usuarios"><i class="fas fa-user-shield"></i> Usuarios</div>
    <div class="tab" data-tab="actividad"><i class="fas fa-chart-line"></i> Actividad</div>
  </div>

  <!-- Sección de Empleados -->
  <div id="empleadosTab" class="tab-content active">
    <!-- Formulario de nuevo empleado -->
    <div class="form-container">
      <h2 class="form-title">Nuevo empleado</h2>
      <div class="form-row">
        <div class="form-group half">
          <label for="employeeName">Nombre completo</label>
          <input type="text" id="employeeName" class="form-control" placeholder="Nombre y apellidos">
        </div>
        <div class="form-group half">
          <label for="employeePosition">Cargo</label>
          <input type="text" id="employeePosition" class="form-control" placeholder="Ej: Recepcionista, Mantenimiento, etc.">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group half">
          <label for="employeeDepartment">Departamento</label>
          <select id="employeeDepartment" class="form-control">
            <option value="recepcion">Recepción</option>
            <option value="limpieza">Limpieza</option>
            <option value="mantenimiento">Mantenimiento</option>
            <option value="restaurante">Restaurante</option>
            <option value="cocina">Cocina</option>
            <option value="administracion">Administración</option>
          </select>
        </div>
        <div class="form-group half">
          <label for="employeeHotel">Hotel</label>
          <select id="employeeHotel" class="form-control">
            <option value="Wave">Wave</option>
            <option value="Sky">Sky</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group half">
          <label for="employeePhone">Teléfono</label>
          <input type="tel" id="employeePhone" class="form-control" placeholder="Número de teléfono">
        </div>
        <div class="form-group half">
          <label for="employeeEmail">Email</label>
          <input type="email" id="employeeEmail" class="form-control" placeholder="Correo electrónico">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="employeeNotes">Notas</label>
          <textarea id="employeeNotes" class="form-control" placeholder="Información adicional..."></textarea>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <button id="saveEmployee" class="btn"><i class="fas fa-save"></i> Guardar Empleado</button>
          <button id="createUserFromEmployee" class="btn btn-primary" disabled><i class="fas fa-user-plus"></i> Crear Usuario</button>
        </div>
      </div>
    </div>

    <!-- Lista de empleados -->
    <div class="data-container">
      <div class="filter-bar">
        <div class="filter-group">
          <span class="filter-label">Departamento:</span>
          <select id="filterEmployeeDepartment" class="filter-select">
            <option value="">Todos</option>
            <option value="recepcion">Recepción</option>
            <option value="limpieza">Limpieza</option>
            <option value="mantenimiento">Mantenimiento</option>
            <option value="restaurante">Restaurante</option>
            <option value="cocina">Cocina</option>
            <option value="administracion">Administración</option>
          </select>
        </div>
        <div class="filter-group">
          <span class="filter-label">Hotel:</span>
          <select id="filterEmployeeHotel" class="filter-select">
            <option value="">Todos</option>
            <option value="Wave">Wave</option>
            <option value="Sky">Sky</option>
          </select>
        </div>
        <div class="spacer"></div>
        <button id="clearEmployeeFilters" class="btn">Limpiar</button>
        <button id="exportEmployeesExcel" class="btn btn-success">
          <i class="fas fa-file-excel"></i> Exportar
        </button>
      </div>
      <div id="employeeContainer" class="card-container">
        <!-- Los empleados se cargarán aquí dinámicamente -->
      </div>
    </div>
  </div>

  <!-- Sección de Usuarios -->
  <div id="usuariosTab" class="tab-content">
    <!-- Formulario de nuevo usuario -->
    <div class="form-container">
      <h2 class="form-title">Nuevo usuario del sistema</h2>
      <div class="form-row">
        <div class="form-group half">
          <label for="userEmail">Email</label>
          <input type="email" id="userEmail" class="form-control" placeholder="Correo electrónico">
        </div>
        <div class="form-group half">
          <label for="userPassword">Contraseña</label>
          <input type="password" id="userPassword" class="form-control" placeholder="Contraseña">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group half">
          <label for="userRole">Rol</label>
          <select id="userRole" class="form-control">
            <option value="user">Usuario Estándar</option>
            <option value="admin">Administrador</option>
          </select>
        </div>
        <div class="form-group half">
          <label for="userEmployee">Vincular a Empleado</label>
          <select id="userEmployee" class="form-control">
            <option value="">-- Sin vincular --</option>
            <!-- Se llenará dinámicamente -->
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <button id="saveUser" class="btn"><i class="fas fa-save"></i> Guardar Usuario</button>
        </div>
      </div>
    </div>

    <!-- Lista de usuarios -->
    <div class="data-container">
      <div id="userContainer" class="card-container">
        <!-- Los usuarios se cargarán aquí dinámicamente -->
      </div>
    </div>
  </div>

  <!-- Sección de Actividad -->
  <div id="actividadTab" class="tab-content">
    <div class="data-container">
      <div class="filter-bar">
        <div class="filter-group">
          <span class="filter-label">Usuario:</span>
          <select id="filterActivityUser" class="filter-select">
            <option value="">Todos</option>
            <!-- Se llenará dinámicamente -->
          </select>
        </div>
        <div class="filter-group">
          <span class="filter-label">Tipo:</span>
          <select id="filterActivityType" class="filter-select">
            <option value="">Todos</option>
            <option value="login">Inicio de sesión</option>
            <option value="task">Tareas</option>
            <option value="order">Pedidos</option>
            <option value="chemical">Químicos</option>
            <option value="shift">Turnos</option>
            <option value="employee">Personal</option>
          </select>
        </div>
        <div class="filter-group">
          <span class="filter-label">Fecha:</span>
          <input type="date" id="filterActivityDate" class="filter-select">
        </div>
        <div class="spacer"></div>
        <button id="clearActivityFilters" class="btn">Limpiar</button>
        <button id="exportActivityExcel" class="btn btn-success">
          <i class="fas fa-file-excel"></i> Exportar
        </button>
      </div>
      <!-- Tabla de actividad -->
      <div class="table-responsive">
        <table class="activity-table">
          <thead>
            <tr>
              <th>Fecha y Hora</th>
              <th>Usuario</th>
              <th>Acción</th>
              <th>Detalles</th>
            </tr>
          </thead>
          <tbody id="activityTableBody">
            <!-- Las actividades se cargarán aquí dinámicamente -->
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Módulo de Turnos de Personal -->
<div id="turnosModule" class="module-content">
  <div class="content-header">
    <h1 class="content-title">Turnos de Personal</h1>
    <div class="content-subtitle">Gestión de horarios y turnos de trabajo</div>
  </div>

  <!-- Navegación del calendario -->
  <div class="form-container">
    <div class="calendar-navigation">
      <button id="prevWeek" class="btn"><i class="fas fa-chevron-left"></i> Semana anterior</button>
      <div id="currentWeekDisplay">10 - 16 mayo, 2025</div>
      <button id="nextWeek" class="btn">Semana siguiente <i class="fas fa-chevron-right"></i></button>
    </div>
    
    <div class="form-row">
      <div class="form-group half">
        <label for="filterTurnoDepartamento">Departamento</label>
        <select id="filterTurnoDepartamento" class="form-control">
          <option value="todos">Todos los departamentos</option>
          <option value="recepcion">Recepción</option>
          <option value="limpieza">Limpieza</option>
          <option value="cocina">Cocina</option>
          <option value="restaurante">Restaurante</option>
          <option value="mantenimiento">Mantenimiento</option>
          <option value="administracion">Administración</option>
        </select>
      </div>
      <div class="form-group half">
        <label for="filterTurnoHotel">Hotel</label>
        <select id="filterTurnoHotel" class="form-control">
          <option value="todos">Todos los hoteles</option>
          <option value="Wave">Wave</option>
          <option value="Sky">Sky</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Calendario de turnos -->
  <div class="data-container">
    <div class="schedule-table-container">
      <table class="schedule-table">
        <thead>
          <tr>
            <th class="employee-col">Empleado</th>
            <th class="day-col">Lunes</th>
            <th class="day-col">Martes</th>
            <th class="day-col">Miércoles</th>
            <th class="day-col">Jueves</th>
            <th class="day-col">Viernes</th>
            <th class="day-col weekend">Sábado</th>
            <th class="day-col weekend">Domingo</th>
          </tr>
          <tr class="date-row">
            <th></th>
            <th>10/05</th>
            <th>11/05</th>
            <th>12/05</th>
            <th>13/05</th>
            <th>14/05</th>
            <th class="weekend">15/05</th>
            <th class="weekend">16/05</th>
          </tr>
        </thead>
        <tbody id="scheduleBody">
          <!-- Las filas se llenarán dinámicamente -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Formulario para añadir/editar turnos -->
  <div class="form-container" id="editShiftForm" style="display: none;">
    <h2 class="form-title">Editar turno</h2>
    <div class="form-row">
      <div class="form-group third">
        <label for="shiftEmployee">Empleado</label>
        <select id="shiftEmployee" class="form-control">
          <!-- Se llenará dinámicamente -->
        </select>
      </div>
      <div class="form-group third">
        <label for="shiftDate">Fecha</label>
        <input type="date" id="shiftDate" class="form-control">
      </div>
      <div class="form-group third">
        <label for="shiftType">Tipo de turno</label>
        <select id="shiftType" class="form-control">
          <option value="morning">Mañana (7:00 - 15:00)</option>
          <option value="afternoon">Tarde (15:00 - 23:00)</option>
          <option value="night">Noche (23:00 - 7:00)</option>
          <option value="off">Descanso</option>
          <option value="vacation">Vacaciones</option>
        </select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label for="shiftNotes">Notas</label>
        <textarea id="shiftNotes" class="form-control" placeholder="Notas adicionales..."></textarea>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <button id="saveShift" class="btn">Guardar Turno</button>
        <button id="cancelEditShift" class="btn btn-warning">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Botones de acción -->
  <div class="action-buttons">
    <button id="addShiftBtn" class="btn btn-success">
      <i class="fas fa-plus"></i> Nuevo Turno
    </button>
    <button id="exportScheduleBtn" class="btn">
      <i class="fas fa-file-export"></i> Exportar Horarios
    </button>
  </div>
</div>
  
        <!-- Código JavaScript -->
        <script>
          // Configuración de Firebase
          const firebaseConfig = {
            apiKey: "AIzaSyBR8e4G0tEpXnUwNpxzM3nvklsbRY1zFI0",
            authDomain: "tareas-invierno.firebaseapp.com",
            projectId: "tareas-invierno",
            storageBucket: "tareas-invierno.appspot.com",
            messagingSenderId: "253712224629",
            appId: "1:253712224629:web:f11abaa587d3816e5a433c",
            measurementId: "G-4Z1W4C05LP"
          };
  
          // Inicializar Firebase
          firebase.initializeApp(firebaseConfig);
          const db = firebase.firestore();
          const auth = firebase.auth();
  
          // Permitir persistencia para usar offline
          db.enablePersistence().catch(err => {
            console.error("Error al habilitar persistencia:", err);
          });
  
          // Colecciones de Firestore
          const tasksCollection = db.collection('tasks');
          const stockCollection = db.collection('stock');
          const ordersCollection = db.collection('orders');
          const usersCollection = db.collection('users');
  
          // Variables globales
          let currentUser = null;
          let isAdmin = false;
          let currentTaskId = null;
          let currentStockId = null;
          let currentOrderId = null;
  
          // Elementos DOM de autenticación
          const loginScreen = document.getElementById('loginScreen');
          const appScreen = document.getElementById('appScreen');
          const emailInput = document.getElementById('email');
          const passwordInput = document.getElementById('password');
          const loginBtn = document.getElementById('loginBtn');
          const loginError = document.getElementById('loginError');
          const logoutBtn = document.getElementById('logoutBtn');
  
          // Elementos DOM de navegación
          const menuBtn = document.getElementById('menuBtn');
          const menuContainer = document.getElementById('menuContainer');
          const moduleItems = document.querySelectorAll('.module-item[data-module]');
          const moduleContents = document.querySelectorAll('.module-content');
  
          // ----------- AUTENTICACIÓN -----------
  
          // Manejo de login
          loginBtn.addEventListener('click', () => {
            const email = emailInput.value.trim();
            const password = passwordInput.value;
  
            if (!email || !password) {
              loginError.textContent = 'Por favor introduce email y contraseña';
              return;
            }
  
            loginBtn.disabled = true;
            loginBtn.textContent = 'Iniciando sesión...';
  
            auth.signInWithEmailAndPassword(email, password)
              .catch(error => {
                console.error('Error de autenticación:', error);
                let errorMessage = 'Error al iniciar sesión';
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                  errorMessage = 'Credenciales incorrectas';
                } else if (error.code === 'auth/invalid-email') {
                  errorMessage = 'Formato de email inválido';
                } else if (error.code === 'auth/too-many-requests') {
                  errorMessage = 'Demasiados intentos. Intenta más tarde';
                }
                loginError.textContent = errorMessage;
                loginBtn.disabled = false;
                loginBtn.textContent = 'Iniciar Sesión';
              });
          });
  
          // Escuchar cambios de sesión
          auth.onAuthStateChanged(user => {
            if (user) {
              currentUser = user;
  
              usersCollection.doc(user.uid).get().then(doc => {
                if (doc.exists && doc.data().role === 'admin') {
                  isAdmin = true;
                  document.body.classList.add('is-admin');
                } else {
                  isAdmin = false;
                  document.body.classList.remove('is-admin');
                }
  
                loginScreen.classList.add('hidden');
                appScreen.classList.remove('hidden');
  
                loadTasks();
                loadStock();
                loadOrders();
                loadChemicals();
              }).catch(error => {
                console.error('Error al verificar rol:', error);
                // Si hay un error al verificar el rol, asumimos que no es admin
                isAdmin = false;
                document.body.classList.remove('is-admin');
                
                loginScreen.classList.add('hidden');
                appScreen.classList.remove('hidden');

                hideRejectDialog();
                
                loadTasks();
                loadStock();
                loadOrders();
              });
  
            } else {
              currentUser = null;
              isAdmin = false;
              document.body.classList.remove('is-admin');
              loginScreen.classList.remove('hidden');
              appScreen.classList.add('hidden');
              emailInput.value = '';
              passwordInput.value = '';
              loginBtn.disabled = false;
              loginBtn.textContent = 'Iniciar Sesión';
              loginError.textContent = '';
            }
          });
  
          // Cerrar sesión
          logoutBtn.addEventListener('click', () => {
            auth.signOut().catch(error => {
              console.error('Error al cerrar sesión:', error);
            });
          });
  
          // ----------- NAVEGACIÓN -----------
  
          // Menú desplegable
          menuBtn.addEventListener('click', () => {
            menuContainer.classList.toggle('open');
            const icon = menuBtn.querySelector('i');
            icon.classList.toggle('fa-chevron-right');
            icon.classList.toggle('fa-chevron-left');
          });
  
          // Cambiar módulo activo
          moduleItems.forEach(item => {
            item.addEventListener('click', () => {
              const moduleId = item.getAttribute('data-module');
              if (moduleId) {
                moduleContents.forEach(content => content.classList.remove('active'));
                document.getElementById(`${moduleId}Module`).classList.add('active');
                menuContainer.classList.remove('open');
                menuBtn.querySelector('i').classList.remove('fa-chevron-left');
                menuBtn.querySelector('i').classList.add('fa-chevron-right');
              }
            });
          });
  
          // Evitar propagación de clics en el menú
          menuContainer.addEventListener('click', (e) => {
            e.stopPropagation();
          });
  
          // Cerrar menú al hacer clic fuera
          document.addEventListener('click', (e) => {
            if (menuContainer.classList.contains('open') && !menuBtn.contains(e.target)) {
              menuContainer.classList.remove('open');
              menuBtn.querySelector('i').classList.remove('fa-chevron-left');
              menuBtn.querySelector('i').classList.add('fa-chevron-right');
            }
          });
  
          // ----------- UTILIDADES -----------
  
          function formatDate(timestamp) {
            if (!timestamp) return 'N/D';
            try {
              const date = timestamp instanceof Date ? timestamp : timestamp.toDate();
              return date.toLocaleDateString('es-ES', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
              });
            } catch (e) {
              return 'Fecha inválida';
            }
          }
  
          function sanitizeHTML(text) {
            if (!text) return '';
            return text
              .replace(/&/g, '&amp;')
              .replace(/</g, '&lt;')
              .replace(/>/g, '&gt;')
              .replace(/"/g, '&quot;')
              .replace(/'/g, '&#039;');
          }
  
          // ----------- MÓDULO: TAREAS -----------
  
          // Elementos DOM del módulo de tareas
          const taskTitle = document.getElementById('taskTitle');
          const taskHotel = document.getElementById('taskHotel');
          const taskArea = document.getElementById('taskArea');
          const taskPriority = document.getElementById('taskPriority');
          const taskCost = document.getElementById('taskCost');
          const taskDescription = document.getElementById('taskDescription');
          const saveTaskBtn = document.getElementById('saveTask');
          const taskContainer = document.getElementById('taskContainer');
          const filterHotel = document.getElementById('filterHotel');
          const filterArea = document.getElementById('filterArea');
          const filterPriority = document.getElementById('filterPriority');
          const clearFiltersBtn = document.getElementById('clearFilters');
          const exportExcelBtn = document.getElementById('exportExcel');
  
          // Cargar tareas
          function loadTasks() {
            tasksCollection.orderBy('createdAt', 'desc').get()
              .then(snapshot => {
                const tasks = [];
                snapshot.forEach(doc => {
                  tasks.push({ id: doc.id, ...doc.data() });
                });
                applyTaskFilters(tasks);
              })
              .catch(error => {
                console.error('Error cargando tareas:', error);
                alert('Error al cargar las tareas');
              });
          }
  
          // Guardar o actualizar tarea
          saveTaskBtn.addEventListener('click', () => {
            // Validar campos
            if (!taskTitle.value.trim()) {
              alert('Por favor introduce un título para la tarea');
              return;
            }
  
            // Preparar datos
            const taskData = {
              title: taskTitle.value.trim(),
              hotel: taskHotel.value,
              area: taskArea.value,
              priority: taskPriority.value,
              cost: Number(taskCost.value) || 0,
              description: taskDescription.value.trim(),
              updatedAt: new Date()
            };
  
            // Si es nueva tarea
            if (!currentTaskId) {
              taskData.createdAt = new Date();
              taskData.createdBy = currentUser.uid;
              taskData.createdByEmail = currentUser.email;
            }
  
            saveTaskBtn.disabled = true;
  
            // Guardar en Firestore
            const savePromise = currentTaskId
              ? tasksCollection.doc(currentTaskId).update(taskData)
              : tasksCollection.add(taskData);
  
            savePromise
              .then(() => {
                resetTaskForm();
                loadTasks();
                saveTaskBtn.disabled = false;
              })
              .catch(error => {
                console.error('Error guardando tarea:', error);
                alert('Error al guardar la tarea');
                saveTaskBtn.disabled = false;
              });
          });
  
          // Resetear formulario de tareas
          function resetTaskForm() {
            taskTitle.value = '';
            taskDescription.value = '';
            taskHotel.value = 'Wave';
            taskArea.value = 'Recepción';
            taskPriority.value = 'Media';
            taskCost.value = '';
            currentTaskId = null;
            saveTaskBtn.textContent = 'Guardar Tarea';
          }
  
          // Filtrar tareas
          function applyTaskFilters(tasks) {
            const hotelFilter = filterHotel.value;
            const areaFilter = filterArea.value;
            const priorityFilter = filterPriority.value;
  
            let filteredTasks = [...tasks];
  
            if (hotelFilter) {
              filteredTasks = filteredTasks.filter(task => task.hotel === hotelFilter);
            }
  
            if (areaFilter) {
              filteredTasks = filteredTasks.filter(task => task.area === areaFilter);
            }
  
            if (priorityFilter) {
              filteredTasks = filteredTasks.filter(task => task.priority === priorityFilter);
            }
  
            renderTasks(filteredTasks);
          }
  
          // Renderizar lista de tareas
          function renderTasks(tasks) {
            taskContainer.innerHTML = '';
  
            if (tasks.length === 0) {
              taskContainer.innerHTML = '<p class="text-center">No hay tareas que coincidan con los filtros</p>';
              return;
            }
  
            tasks.forEach(task => {
              const card = document.createElement('div');
              card.className = 'task-card';
  
              const priorityClass = `priority-${task.priority.toLowerCase()}`;
  
              card.innerHTML = `
                <div class="task-header">
                  <h3 class="task-title">${sanitizeHTML(task.title)}</h3>
                  <span class="task-priority ${priorityClass}">${sanitizeHTML(task.priority)}</span>
                </div>
                <div class="task-meta">
                  <div class="task-hotel">
                    <i class="fas fa-hotel"></i> ${sanitizeHTML(task.hotel || 'No especificado')}
                  </div>
                  <div class="task-area">
                    <i class="fas fa-map-marker-alt"></i> ${sanitizeHTML(task.area)}
                  </div>
                  <div class="task-date">
                    <i class="fas fa-calendar-alt"></i> ${formatDate(task.createdAt)}
                  </div>
                </div>
                ${task.description ? `<div class="task-description">${sanitizeHTML(task.description)}</div>` : ''}
                <div class="task-cost">
                  <i class="fas fa-euro-sign"></i> ${task.cost.toFixed(2)}€
                </div>
                <div class="task-actions">
                  <button class="btn btn-warning btn-edit" onclick="editTask('${task.id}')">
                    <i class="fas fa-edit"></i> Editar
                  </button>
                  <button class="btn btn-danger btn-delete" onclick="deleteTask('${task.id}')">
                    <i class="fas fa-trash"></i> Eliminar
                  </button>
                </div>
              `;
  
              taskContainer.appendChild(card);
            });
          }
  
          // Editar tarea
          function editTask(taskId) {
            tasksCollection.doc(taskId).get()
              .then(doc => {
                if (doc.exists) {
                  const task = doc.data();
  
                  taskTitle.value = task.title || '';
                  taskHotel.value = task.hotel || 'Wave';
                  taskArea.value = task.area || 'Recepción';
                  taskPriority.value = task.priority || 'Media';
                  taskCost.value = task.cost || '';
                  taskDescription.value = task.description || '';
  
                  currentTaskId = taskId;
                  saveTaskBtn.textContent = 'Actualizar Tarea';
  
                  // Desplazar hasta el formulario
                  document.querySelector('.form-container').scrollIntoView({ behavior: 'smooth' });
                } else {
                  alert('No se encontró la tarea');
                }
              })
              .catch(error => {
                console.error('Error obteniendo tarea:', error);
                alert('Error al cargar la tarea');
              });
          }
  
          // Eliminar tarea
          function deleteTask(taskId) {
            if (confirm('¿Estás seguro de que deseas eliminar esta tarea?')) {
              tasksCollection.doc(taskId).delete()
                .then(() => {
                  if (currentTaskId === taskId) {
                    resetTaskForm();
                  }
                  loadTasks();
                })
                .catch(error => {
                  console.error('Error eliminando tarea:', error);
                  alert('Error al eliminar la tarea');
                });
            }
          }
  
          // Eventos de filtros
          filterHotel.addEventListener('change', () => loadTasks());
          filterArea.addEventListener('change', () => loadTasks());
          filterPriority.addEventListener('change', () => loadTasks());
  
          clearFiltersBtn.addEventListener('click', () => {
            filterHotel.value = '';
            filterArea.value = '';
            filterPriority.value = '';
            loadTasks();
          });
  
          // Exportar a Excel
          exportExcelBtn.addEventListener('click', () => {
            tasksCollection.orderBy('createdAt', 'desc').get()
              .then(snapshot => {
                if (snapshot.empty) {
                  alert('No hay tareas para exportar');
                  return;
                }
  
                const tasks = [];
                snapshot.forEach(doc => {
                  const task = doc.data();
                  tasks.push({
                    'Título': task.title,
                    'Hotel': task.hotel || 'No especificado',
                    'Área': task.area,
                    'Prioridad': task.priority,
                    'Descripción': task.description || '',
                    'Coste (€)': task.cost,
                    'Fecha': formatDate(task.createdAt),
                    'Creado por': task.createdByEmail || 'Desconocido'
                  });
                });
  
                // Crear libro Excel
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(tasks);
  
                // Añadir hoja al libro
                XLSX.utils.book_append_sheet(wb, ws, 'Tareas de Mejora');
  
                // Generar el archivo Excel
                const date = new Date().toISOString().split('T')[0];
                XLSX.writeFile(wb, `Tareas_Mejora_${date}.xlsx`);
              })
              .catch(error => {
                console.error('Error exportando a Excel:', error);
                alert('Error al exportar a Excel');
              });
          });
  
          // ----------- MÓDULO: STOCK -----------
  
          // Elementos DOM del módulo de stock
          const stockName = document.getElementById('stockName');
          const orderTitle = document.getElementById('orderTitle');
        const orderSupplier = document.getElementById('orderSupplier');
        const orderDate = document.getElementById('orderDate');
        const orderAmount = document.getElementById('orderAmount');
        const orderItems = document.getElementById('orderItems');
        const saveOrderBtn = document.getElementById('saveOrder');
        const orderContainer = document.getElementById('orderContainer');
        const filterOrderStatus = document.getElementById('filterOrderStatus');
        const filterOrderSupplier = document.getElementById('filterOrderSupplier');
        const clearOrderFiltersBtn = document.getElementById('clearOrderFilters');
        const exportOrderExcelBtn = document.getElementById('exportOrderExcel');
          const stockCategory = document.getElementById('stockCategory');
          const stockQuantity = document.getElementById('stockQuantity');
          const stockMinimum = document.getElementById('stockMinimum');
          const stockUnit = document.getElementById('stockUnit');
          const stockNotes = document.getElementById('stockNotes');
          const saveStockBtn = document.getElementById('saveStock');
          const stockContainer = document.getElementById('stockContainer');
          const filterStockCategory = document.getElementById('filterStockCategory');
          const filterStockLevel = document.getElementById('filterStockLevel');
          const clearStockFiltersBtn = document.getElementById('clearStockFilters');
          const exportStockExcelBtn = document.getElementById('exportStockExcel');
  
          // Cargar stock
          function loadStock() {
            stockCollection.orderBy('name').get()
              .then(snapshot => {
                const items = [];
                snapshot.forEach(doc => {
                  items.push({ id: doc.id, ...doc.data() });
                });
                applyStockFilters(items);
              })
              .catch(error => {
                console.error('Error cargando stock:', error);
                alert('Error al cargar el inventario');
              });
          }
  
          // Guardar o actualizar ítem de stock
          saveStockBtn.addEventListener('click', () => {
            // Validar campos
            if (!stockName.value.trim()) {
              alert('Por favor introduce un nombre para el producto');
              return;
            }
  
            // Preparar datos
            const stockData = {
              name: stockName.value.trim(),
              category: stockCategory.value,
              quantity: Number(stockQuantity.value) || 0,
              minimum: Number(stockMinimum.value) || 0,
              unit: stockUnit.value,
              notes: stockNotes.value.trim(),
              updatedAt: new Date(),
              updatedBy: currentUser.uid,
              updatedByEmail: currentUser.email
            };
  
            // Si es nuevo ítem
            if (!currentStockId) {
              stockData.createdAt = new Date();
              stockData.createdBy = currentUser.uid;
              stockData.createdByEmail = currentUser.email;
            }
  
            saveStockBtn.disabled = true;
  
            // Guardar en Firestore
            const savePromise = currentStockId
              ? stockCollection.doc(currentStockId).update(stockData)
              : stockCollection.add(stockData);
  
            savePromise
              .then(() => {
                resetStockForm();
                loadStock();
                saveStockBtn.disabled = false;
              })
              .catch(error => {
                console.error('Error guardando ítem de stock:', error);
                alert('Error al guardar el producto');
                saveStockBtn.disabled = false;
              });
          });
  
          // Resetear formulario de stock
          function resetStockForm() {
            stockName.value = '';
            stockCategory.value = 'Limpieza';
            stockQuantity.value = '';
            stockMinimum.value = '';
            stockUnit.value = 'Unidades';
            stockNotes.value = '';
            currentStockId = null;
            saveStockBtn.textContent = 'Guardar Producto';
          }
  
          // Determinar nivel de stock
          function getStockLevel(quantity, minimum) {
            if (quantity <= 0) {
              return { level: 'low', text: 'Agotado', class: 'stock-level-low' };
            } else if (quantity < minimum) {
              return { level: 'low', text: 'Bajo mínimo', class: 'stock-level-low' };
            } else if (quantity < minimum * 2) {
              return { level: 'medium', text: 'Regular', class: 'stock-level-medium' };
            } else {
              return { level: 'good', text: 'Adecuado', class: 'stock-level-good' };
            }
          }
  
          // Filtrar stock
          function applyStockFilters(items) {
            const categoryFilter = filterStockCategory.value;
            const levelFilter = filterStockLevel.value;
  
            let filteredItems = [...items];
  
            if (categoryFilter) {
              filteredItems = filteredItems.filter(item => item.category === categoryFilter);
            }
  
            if (levelFilter) {
              filteredItems = filteredItems.filter(item => {
                const level = getStockLevel(item.quantity, item.minimum).level;
                return level === levelFilter;
              });
            }
  
            renderStock(filteredItems);
          }
  
          // Renderizar lista de stock
          function renderStock(items) {
            stockContainer.innerHTML = '';
  
            if (items.length === 0) {
              stockContainer.innerHTML = '<p class="text-center">No hay productos que coincidan con los filtros</p>';
              return;
            }
  
            items.forEach(item => {
              const stockLevel = getStockLevel(item.quantity, item.minimum);
  
              const div = document.createElement('div');
              div.className = 'stock-item';
  
              div.innerHTML = `
                <div class="stock-name">
                  <div>${sanitizeHTML(item.name)}</div>
                  <div style="font-size: 0.85rem; color: #666;">
                    <i class="fas fa-tag"></i> ${sanitizeHTML(item.category)}
                  </div>
                </div>
                <div class="stock-quantity">
                  <div class="${stockLevel.class}">
                    <strong>${item.quantity} ${item.unit}</strong>
                  </div>
                  <div style="font-size: 0.8rem;">
                    ${stockLevel.text} (Mín: ${item.minimum})
                  </div>
                </div>
                <div class="stock-actions">
                  <button class="btn btn-sm btn-warning" onclick="editStock('${item.id}')">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="btn btn-sm btn-danger" onclick="deleteStock('${item.id}')">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              `;
  
              stockContainer.appendChild(div);
            });
          }
  
          // Editar ítem de stock
          function editStock(itemId) {
            stockCollection.doc(itemId).get()
              .then(doc => {
                if (doc.exists) {
                  const item = doc.data();
  
                  stockName.value = item.name || '';
                  stockCategory.value = item.category || 'Limpieza';
                  stockQuantity.value = item.quantity || '';
                  stockMinimum.value = item.minimum || '';
                  stockUnit.value = item.unit || 'Unidades';
                  stockNotes.value = item.notes || '';
  
                  currentStockId = itemId;
                  saveStockBtn.textContent = 'Actualizar Producto';
  
                  // Desplazar hasta el formulario
                  document.getElementById('stockModule').querySelector('.form-container').scrollIntoView({ behavior: 'smooth' });
                } else {
                  alert('No se encontró el producto');
                }
              })
              .catch(error => {
                console.error('Error obteniendo ítem de stock:', error);
                alert('Error al cargar el producto');
              });
          }
  
          // Eliminar ítem de stock
          function deleteStock(itemId) {
            if (confirm('¿Estás seguro de que deseas eliminar este producto?')) {
              stockCollection.doc(itemId).delete()
                .then(() => {
                  if (currentStockId === itemId) {
                    resetStockForm();
                  }
                  loadStock();
                })
                .catch(error => {
                  console.error('Error eliminando ítem de stock:', error);
                  alert('Error al eliminar el producto');
                });
            }
          }
  
          // Eventos de filtros de stock
          filterStockCategory.addEventListener('change', () => loadStock());
          filterStockLevel.addEventListener('change', () => loadStock());
  
          clearStockFiltersBtn.addEventListener('click', () => {
            filterStockCategory.value = '';
            filterStockLevel.value = '';
            loadStock();
          });
  
          // Exportar stock a Excel
          exportStockExcelBtn.addEventListener('click', () => {
            stockCollection.orderBy('name').get()
              .then(snapshot => {
                if (snapshot.empty) {
                  alert('No hay productos para exportar');
                  return;
                }
  
                const stockItems = [];
                snapshot.forEach(doc => {
                  const item = doc.data();
                  const stockLevel = getStockLevel(item.quantity, item.minimum);
  
                  stockItems.push({
                    'Nombre': item.name,
                    'Categoría': item.category,
                    'Cantidad': item.quantity,
                    'Unidad': item.unit,
                    'Mínimo': item.minimum,
                    'Estado': stockLevel.text,
                    'Notas': item.notes || '',
                    'Actualizado': formatDate(item.updatedAt),
                    'Por': item.updatedByEmail || 'Desconocido'
                  });
                });
  
                // Crear libro Excel
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(stockItems);
  
                // Añadir hoja al libro
                XLSX.utils.book_append_sheet(wb, ws, 'Inventario');
  
                // Generar el archivo Excel
                const date = new Date().toISOString().split('T')[0];
                XLSX.writeFile(wb, `Inventario_${date}.xlsx`);
              })
              .catch(error => {
                console.error('Error exportando a Excel:', error);
                alert('Error al exportar a Excel');
              });
          });

          function loadOrders() {
  const orders = [];
  const suppliers = new Set();

  ordersCollection.orderBy('createdAt', 'desc').get()
    .then(snapshot => {
      snapshot.forEach(doc => {
        const order = { id: doc.id, ...doc.data() };
        orders.push(order);
        if (order.supplier) {
          suppliers.add(order.supplier);
        }
      });

      updateSupplierFilter(suppliers);
      applyOrderFilters(orders);
    })
    .catch(error => {
      console.error('Error cargando pedidos:', error);
      alert('Error al cargar los pedidos');
    });
}
    
        // Actualizar selector de proveedores
        function updateSupplierFilter(suppliers) {
          // Guardar valor actual
          const currentValue = filterOrderSupplier.value;

          // Limpiar opciones actuales excepto la primera
          while (filterOrderSupplier.options.length > 1) {
            filterOrderSupplier.remove(1);
          }

          // Agregar nuevas opciones
          suppliers.forEach(supplier => {
            const option = document.createElement('option');
            option.value = supplier;
            option.textContent = supplier;
            filterOrderSupplier.appendChild(option);
          });

          // Restaurar valor si existía
          if (currentValue && [...suppliers].includes(currentValue)) {
            filterOrderSupplier.value = currentValue;
          }
        }

        // Guardar o actualizar pedido
        saveOrderBtn.addEventListener('click', () => {
          // Validar campos requeridos
          if (!orderTitle.value.trim()) {
            alert('Por favor introduce un título para el pedido');
            return;
          }

          if (!orderSupplier.value.trim()) {
            alert('Por favor introduce el nombre del proveedor');
            return;
          }

          // Preparar datos
          const orderData = {
            title: orderTitle.value.trim(),
            supplier: orderSupplier.value.trim(),
            date: orderDate.value ? new Date(orderDate.value) : null,
            amount: Number(orderAmount.value) || 0,
            items: orderItems.value.trim(),
            updatedAt: new Date(),
            updatedBy: currentUser.uid,
            updatedByEmail: currentUser.email
          };

          // Si es nuevo pedido, añadir campos adicionales
          if (!currentOrderId) {
            orderData.createdAt = new Date();
            orderData.createdBy = currentUser.uid;
            orderData.createdByEmail = currentUser.email;
            orderData.status = 'Pendiente';
          }

          saveOrderBtn.disabled = true;

          // Guardar en Firestore
          const savePromise = currentOrderId
            ? ordersCollection.doc(currentOrderId).update(orderData)
            : ordersCollection.add(orderData);

          savePromise
            .then(() => {
              resetOrderForm();
              loadOrders();
              saveOrderBtn.disabled = false;
            })
            .catch(error => {
              console.error('Error guardando pedido:', error);
              alert('Error al guardar el pedido');
              saveOrderBtn.disabled = false;
            });
        });

        // Resetear formulario de pedidos
        function resetOrderForm() {
          orderTitle.value = '';
          orderSupplier.value = '';
          orderDate.value = '';
          orderAmount.value = '';
          orderItems.value = '';
          currentOrderId = null;
          saveOrderBtn.textContent = 'Guardar Pedido';
        }

        // Filtrar pedidos
        function applyOrderFilters(orders) {
          const statusFilter = filterOrderStatus.value;
          const supplierFilter = filterOrderSupplier.value;

          let filteredOrders = [...orders];

          if (statusFilter) {
            filteredOrders = filteredOrders.filter(order => order.status === statusFilter);
          }

          if (supplierFilter) {
            filteredOrders = filteredOrders.filter(order => order.supplier === supplierFilter);
          }

          renderOrders(filteredOrders);
        }

        // Renderizar lista de pedidos
        function renderOrders(orders) {
          orderContainer.innerHTML = '';

          if (orders.length === 0) {
            orderContainer.innerHTML = '<p class="text-center">No hay pedidos que coincidan con los filtros</p>';
            return;
          }

          orders.forEach(order => {
            const card = document.createElement('div');
            card.className = 'task-card';

            const statusClass = `status-${order.status ? order.status.toLowerCase() : 'pendiente'}`;

            card.innerHTML = `
              <div class="task-header">
                <h3 class="task-title">${sanitizeHTML(order.title)}</h3>
                <span class="order-status ${statusClass}">${sanitizeHTML(order.status || 'Pendiente')}</span>
              </div>
              <div class="task-meta">
                <div class="task-supplier">
                  <i class="fas fa-building"></i> ${sanitizeHTML(order.supplier)}
                </div>
                <div class="task-date">
                  <i class="fas fa-calendar-alt"></i> ${order.date ? formatDate(order.date) : 'Sin fecha'}
                </div>
              </div>
              ${order.items ? `<div class="task-description">${sanitizeHTML(order.items)}</div>` : ''}
              <div class="task-cost">
                <i class="fas fa-euro-sign"></i> ${order.amount.toFixed(2)}€
              </div>
              <div class="task-actions">
                <button class="btn btn-warning" onclick="editOrder('${order.id}')">
                  <i class="fas fa-edit"></i> Editar
                </button>
                ${isAdmin ? `
                <button class="btn btn-primary" onclick="updateOrderStatus('${order.id}', 'Solicitado')" ${order.status === 'Solicitado' ? 'disabled' : ''}>
                  <i class="fas fa-shopping-cart"></i> Solicitado
                </button>
                <button class="btn btn-success" onclick="updateOrderStatus('${order.id}', 'Completado')" ${order.status === 'Completado' ? 'disabled' : ''}>
                  <i class="fas fa-check-circle"></i> Completado
                </button>
                <button class="btn btn-danger" onclick="showRejectDialog('${order.id}')" ${order.status === 'Rechazado' ? 'disabled' : ''}>
                  <i class="fas fa-times"></i> Rechazar
                </button>
              ` : ''}
              </div>
            `;

            if (order.status === 'Rechazado' && order.rejectReason) {
      card.innerHTML += `
        <div class="reject-reason">
          <strong>Motivo del rechazo:</strong> ${sanitizeHTML(order.rejectReason)}
        </div>
      `;
    }

            orderContainer.appendChild(card);
          });
        }

        // Editar pedido
        function editOrder(orderId) {
          ordersCollection.doc(orderId).get()
            .then(doc => {
              if (doc.exists) {
                const order = doc.data();

                orderTitle.value = order.title || '';
                orderSupplier.value = order.supplier || '';

                // Formatear fecha para input date
                if (order.date) {
                  try {
                    const date = order.date.toDate();
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    orderDate.value = `${year}-${month}-${day}`;
                  } catch (e) {
                    orderDate.value = '';
                  }
                } else {
                  orderDate.value = '';
                }

                orderAmount.value = order.amount || '';
                orderItems.value = order.items || '';

                currentOrderId = orderId;
                saveOrderBtn.textContent = 'Actualizar Pedido';

                // Desplazar hasta el formulario
                document.getElementById('pedidosModule').querySelector('.form-container').scrollIntoView({ behavior: 'smooth' });
              } else {
                alert('No se encontró el pedido');
              }
            })
            .catch(error => {
              console.error('Error obteniendo pedido:', error);
              alert('Error al cargar el pedido');
            });
        }

        // Eliminar pedido
        function deleteOrder(orderId) {
          if (confirm('¿Estás seguro de que deseas eliminar este pedido?')) {
            ordersCollection.doc(orderId).delete()
              .then(() => {
                if (currentOrderId === orderId) {
                  resetOrderForm();
                }
                loadOrders();
              })
              .catch(error => {
                console.error('Error eliminando pedido:', error);
                alert('Error al eliminar el pedido');
              });
          }
        }

        // Actualizar estado de pedido (solo admin)
        function updateOrderStatus(orderId, status, reason = '') {
          if (!isAdmin) return;

          const updateData = {
            status: status,
            updatedAt: new Date(),
            updatedBy: currentUser.uid,
            updatedByEmail: currentUser.email
          };
          
          // Si hay motivo de rechazo, lo añadimos
          if (status === 'Rechazado' && reason) {
            updateData.rejectReason = reason;
          }

          ordersCollection.doc(orderId).update(updateData)
            .then(() => {
              loadOrders();
            })
            .catch(error => {
              console.error('Error actualizando estado del pedido:', error);
              alert('Error al actualizar el estado del pedido');
            });
        }

        // Mostrar diálogo de rechazo
        function showRejectDialog(orderId) {
          document.getElementById('rejectDialog').classList.remove('hidden');
          document.getElementById('rejectReason').value = '';
          
          // Configurar el botón de confirmar
          document.getElementById('confirmRejectBtn').onclick = function() {
            const reason = document.getElementById('rejectReason').value.trim();
            updateOrderStatus(orderId, 'Rechazado', reason);
            hideRejectDialog();
          };
        }

        // Ocultar diálogo de rechazo
        function hideRejectDialog() {
          document.getElementById('rejectDialog').classList.add('hidden');
        }

        // Eventos de filtros de pedidos
        filterOrderStatus.addEventListener('change', () => loadOrders());
        filterOrderSupplier.addEventListener('change', () => loadOrders());

        clearOrderFiltersBtn.addEventListener('click', () => {
          filterOrderStatus.value = '';
          filterOrderSupplier.value = '';
          loadOrders();
        });

        // Exportar pedidos a Excel
        exportOrderExcelBtn.addEventListener('click', () => {
          ordersCollection.orderBy('createdAt', 'desc').get()
            .then(snapshot => {
              if (snapshot.empty) {
                alert('No hay pedidos para exportar');
                return;
              }

              const orders = [];
              snapshot.forEach(doc => {
                const order = doc.data();

                orders.push({
                  'Título': order.title,
                  'Proveedor': order.supplier,
                  'Fecha': order.date ? formatDate(order.date) : 'Sin fecha',
                  'Importe (€)': order.amount,
                  'Estado': order.status || 'Pendiente',
                  'Elementos': order.items || '',
                  'Creado': formatDate(order.createdAt),
                  'Por': order.createdByEmail || 'Desconocido',
                  'Actualizado': formatDate(order.updatedAt)
                });
              });

              // Crear libro Excel
              const wb = XLSX.utils.book_new();
              const ws = XLSX.utils.json_to_sheet(orders);

              // Añadir hoja al libro
              XLSX.utils.book_append_sheet(wb, ws, 'Pedidos');

              // Generar el archivo Excel
              const date = new Date().toISOString().split('T')[0];
              XLSX.writeFile(wb, `Pedidos_${date}.xlsx`);
            })
            .catch(error => {
              console.error('Error exportando a Excel:', error);
              alert('Error al exportar a Excel');
            });
        });

        // ----------- INICIALIZACIÓN -----------
        
        document.addEventListener('DOMContentLoaded', () => {
  // Ocultar explícitamente el modal de rechazo al iniciar
  if (document.getElementById('rejectDialog')) {
    document.getElementById('rejectDialog').classList.add('hidden');
  }

  if (auth.currentUser) {
    loginScreen.classList.add('hidden');
    appScreen.classList.remove('hidden');
  } else {
    loginScreen.classList.remove('hidden');
    appScreen.classList.add('hidden');
  }

  if (orderDate) {
    const today = new Date().toISOString().split('T')[0];
    orderDate.setAttribute('min', today);
  }
  
  // Inicializar lista de productos químicos si existe el elemento
  if (chemicalProductsList) {
    initChemicalProductsList();
  }
  // Inicializar módulo de turnos si existe
  if (document.getElementById('turnosModule')) {
    // Verificar si hay sesión iniciada
    if (auth.currentUser) {
      seedEmployeesData().then(() => {
        initTurnosModule();
      });
    } else {
      // Si no hay sesión, configurar un listener para cuando se inicie sesión
      const authHandler = () => {
        if (auth.currentUser) {
          seedEmployeesData().then(() => {
            initTurnosModule();
          });
          auth.removeEventListener('authStateChanged', authHandler);
        }
      };
      auth.onAuthStateChanged(authHandler);
    }
  }


  // Agregar botón combinado para móviles
  if (window.innerWidth <= 768) {
    const actionsContainer = document.querySelector('#quimicosModule .form-row:last-child .form-group');
    if (actionsContainer) {
      const saveAndShareBtn = document.createElement('button');
      saveAndShareBtn.id = 'saveAndShareChemical';
      saveAndShareBtn.className = 'btn btn-primary';
      saveAndShareBtn.innerHTML = '<i class="fas fa-save"></i> <i class="fab fa-whatsapp"></i> Guardar y Compartir';
      
      // Insertar antes del último botón
      actionsContainer.insertBefore(saveAndShareBtn, actionsContainer.lastElementChild);
      
      // Agregar evento
      document.getElementById('saveAndShareChemical').addEventListener('click', () => {
        // Validar y guardar primero
        if (validateChemicalForm()) {
          saveChemicalAndShare();
        }
      });
    }
  }
});

        // Función para validar el formulario
function validateChemicalForm() {
  // Validar título
  if (!chemicalTitle.value.trim()) {
    alert('Por favor introduce un título para el pedido');
    return false;
  }
  
  // Verificar si hay al menos un producto con cantidad
  let hasProducts = false;
  const waveInputs = document.querySelectorAll('.wave-qty');
  const skyInputs = document.querySelectorAll('.sky-qty');
  
  for (let i = 0; i < waveInputs.length; i++) {
    const waveQty = parseInt(waveInputs[i].value) || 0;
    const skyQty = parseInt(skyInputs[i].value) || 0;
    
    if (waveQty > 0 || skyQty > 0) {
      hasProducts = true;
      break;
    }
  }
  
  if (!hasProducts) {
    alert('Por favor introduce al menos un producto con cantidad mayor a cero');
    return false;
  }
  
  return true;
}

// Función para guardar y compartir en un paso
function saveChemicalAndShare() {
  // Recopilar datos del formulario
  const productQuantities = [];
  const waveInputs = document.querySelectorAll('.wave-qty');
  const skyInputs = document.querySelectorAll('.sky-qty');
  
  for (let i = 0; i < waveInputs.length; i++) {
    const productId = parseInt(waveInputs[i].getAttribute('data-product-id'));
    const waveQty = parseInt(waveInputs[i].value) || 0;
    const skyQty = parseInt(skyInputs[i].value) || 0;
    
    if (waveQty > 0 || skyQty > 0) {
      const product = chemicalProducts.find(p => p.id === productId);
      productQuantities.push({
        productId,
        name: product.name,
        unit: product.unit,
        waveQty,
        skyQty
      });
    }
  }

  // Preparar datos
  const chemicalData = {
    title: chemicalTitle.value.trim(),
    hotel: chemicalHotel.value,
    notes: chemicalNotes.value.trim(),
    products: productQuantities,
    createdAt: new Date(),
    createdBy: currentUser.uid,
    createdByEmail: currentUser.email,
    status: 'Pendiente'
  };

  // Guardar en Firestore primero
  chemicalsCollection.add(chemicalData)
    .then(docRef => {
      // Compartir por WhatsApp después de guardar exitosamente
      let messageText = `*${chemicalData.title}*\n\n`;
      
      if (chemicalData.hotel !== 'Ambos') {
        messageText += `Hotel: ${chemicalData.hotel}\n\n`;
      }
      
      messageText += "Productos:\n";
      
      chemicalData.products.forEach(product => {
        if (chemicalData.hotel === 'Ambos') {
          if (product.waveQty > 0 && product.skyQty > 0) {
            messageText += `- ${product.name}: Wave=${product.waveQty} ${product.unit}, Sky=${product.skyQty} ${product.unit}\n`;
          } else if (product.waveQty > 0) {
            messageText += `- ${product.name}: Wave=${product.waveQty} ${product.unit}\n`;
          } else {
            messageText += `- ${product.name}: Sky=${product.skyQty} ${product.unit}\n`;
          }
        } else if (chemicalData.hotel === 'Wave') {
          messageText += `- ${product.name}: ${product.waveQty} ${product.unit}\n`;
        } else {
          messageText += `- ${product.name}: ${product.skyQty} ${product.unit}\n`;
        }
      });
      
      if (chemicalData.notes) {
        messageText += `\nNotas: ${chemicalData.notes}`;
      }
      
      // Resetear formulario
      resetChemicalForm();
      
      // Recargar lista
      loadChemicals();
      
      // Codificar mensaje para URL
      const encodedMessage = encodeURIComponent(messageText);
      
      // Abrir WhatsApp
      window.open(`https://wa.me/?text=${encodedMessage}`, '_blank');
    })
    .catch(error => {
      console.error('Error guardando pedido químico:', error);
      alert('Error al guardar el pedido');
    });
}

        // Exponer funciones al ámbito global para los botones inline
        window.editTask = editTask;
window.deleteTask = deleteTask;
window.editStock = editStock;
window.deleteStock = deleteStock;
window.editOrder = editOrder;
window.deleteOrder = deleteOrder;
window.updateOrderStatus = updateOrderStatus;
window.showRejectDialog = showRejectDialog;
window.hideRejectDialog = hideRejectDialog;
window.shareChemicalWhatsApp = shareChemicalWhatsApp;
window.deleteChemical = deleteChemical;
window.validateChemicalForm = validateChemicalForm;  // Nueva función
window.saveChemicalAndShare = saveChemicalAndShare;  // Nueva función
        // Gestión de errores general
        window.addEventListener('error', (event) => {
          console.error('Error en la aplicación:', event.error);
          alert('Ha ocurrido un error en la aplicación. Por favor, contacte con soporte técnico.');
        });
      </script>
      <script>
        // Crear diálogo dinámicamente cuando se necesite
        function showRejectDialog(orderId) {
          // Verificar si ya existe el diálogo
          let rejectDialog = document.getElementById('rejectDialog');
          
          if (!rejectDialog) {
            // Crear el diálogo si no existe
            rejectDialog = document.createElement('div');
            rejectDialog.id = 'rejectDialog';
            rejectDialog.className = 'modal-overlay';
            rejectDialog.style.display = 'none'; // Inicialmente oculto
            
            rejectDialog.innerHTML = `
              <div class="modal-container">
                <div class="modal-header">
                  <h3>Rechazar Pedido</h3>
                  <span class="close-modal" onclick="document.getElementById('rejectDialog').style.display='none'">
                    <i class="fas fa-times"></i>
                  </span>
                </div>
                <div class="modal-body">
                  <div class="form-group">
                    <label for="rejectReason">Motivo del rechazo:</label>
                    <textarea id="rejectReason" class="form-control" placeholder="Explica por qué se rechaza este pedido..."></textarea>
                  </div>
                </div>
                <div class="modal-footer">
                  <button class="btn" onclick="document.getElementById('rejectDialog').style.display='none'">
                    Cancelar
                  </button>
                  <button class="btn btn-danger" id="confirmRejectBtn">
                    Confirmar Rechazo
                  </button>
                </div>
              </div>
            `;
            
            document.body.appendChild(rejectDialog);
          }
          
          // Mostrar el diálogo
          rejectDialog.style.display = 'flex';
          document.getElementById('rejectReason').value = '';
          
          // Configurar el botón de confirmar
          document.getElementById('confirmRejectBtn').onclick = function() {
            const reason = document.getElementById('rejectReason').value.trim();
            updateOrderStatus(orderId, 'Rechazado', reason);
            document.getElementById('rejectDialog').style.display = 'none';
          };
      
          // Agregar cierre con ESC
          const escHandler = function(e) {
            if (e.key === 'Escape') {
              document.getElementById('rejectDialog').style.display = 'none';
              document.removeEventListener('keydown', escHandler);
            }
          };
          document.addEventListener('keydown', escHandler);
        }
      
        // Reemplazar la función hideRejectDialog
        function hideRejectDialog() {
          const dialog = document.getElementById('rejectDialog');
          if (dialog) {
            dialog.style.display = 'none';
          }
        }
      
        // Asegurarnos de que no haya diálogos residuales
        window.onload = function() {
          hideRejectDialog();
          
          // Exponer funciones a nivel global (si no estaba ya en el código)
          window.showRejectDialog = showRejectDialog;
          window.hideRejectDialog = hideRejectDialog;
        };

        // ----------- MÓDULO: PERSONAL -----------

// Referencias a elementos DOM
const tabs = document.querySelectorAll('.tab');
const tabContents = document.querySelectorAll('.tab-content');

// Elementos DOM del tab de empleados
const employeeName = document.getElementById('employeeName');
const employeePosition = document.getElementById('employeePosition');
const employeeDepartment = document.getElementById('employeeDepartment');
const employeeHotel = document.getElementById('employeeHotel');
const employeePhone = document.getElementById('employeePhone');
const employeeEmail = document.getElementById('employeeEmail');
const employeeNotes = document.getElementById('employeeNotes');
const saveEmployeeBtn = document.getElementById('saveEmployee');
const createUserFromEmployeeBtn = document.getElementById('createUserFromEmployee');
const employeeContainer = document.getElementById('employeeContainer');
const filterEmployeeDepartment = document.getElementById('filterEmployeeDepartment');
const filterEmployeeHotel = document.getElementById('filterEmployeeHotel');
const clearEmployeeFiltersBtn = document.getElementById('clearEmployeeFilters');
const exportEmployeesExcelBtn = document.getElementById('exportEmployeesExcel');

// Elementos DOM del tab de usuarios
const userEmail = document.getElementById('userEmail');
const userPassword = document.getElementById('userPassword');
const userRole = document.getElementById('userRole');
const userEmployee = document.getElementById('userEmployee');
const saveUserBtn = document.getElementById('saveUser');
const userContainer = document.getElementById('userContainer');

// Elementos DOM del tab de actividad
const filterActivityUser = document.getElementById('filterActivityUser');
const filterActivityType = document.getElementById('filterActivityType');
const filterActivityDate = document.getElementById('filterActivityDate');
const clearActivityFiltersBtn = document.getElementById('clearActivityFilters');
const exportActivityExcelBtn = document.getElementById('exportActivityExcel');
const activityTableBody = document.getElementById('activityTableBody');

// Colección de Firestore para actividad
const activityCollection = db.collection('activity');

// Variables globales
let currentEmployeeId = null;

// Inicializar módulo de personal
function initPersonalModule() {
  // Configurar navegación por tabs
  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      const tabId = tab.getAttribute('data-tab');
      
      // Activar tab y contenido correspondiente
      tabs.forEach(t => t.classList.remove('active'));
      tabContents.forEach(content => content.classList.remove('active'));
      
      tab.classList.add('active');
      document.getElementById(`${tabId}Tab`).classList.add('active');
      
      // Cargar datos específicos del tab
      if (tabId === 'empleados') {
        loadEmployeesForManagement();
      } else if (tabId === 'usuarios') {
        loadUsersForManagement();
        loadEmployeesForUserSelect();
      } else if (tabId === 'actividad') {
        loadUsersForActivityFilter();
        loadActivity();
      }
    });
  });
  
  // Configurar botones y eventos
  saveEmployeeBtn.addEventListener('click', saveEmployee);
  createUserFromEmployeeBtn.addEventListener('click', showCreateUserForm);
  saveUserBtn.addEventListener('click', saveUser);
  
  // Configurar filtros
  filterEmployeeDepartment.addEventListener('change', loadEmployeesForManagement);
  filterEmployeeHotel.addEventListener('change', loadEmployeesForManagement);
  clearEmployeeFiltersBtn.addEventListener('click', clearEmployeeFilters);
  
  filterActivityUser.addEventListener('change', loadActivity);
  filterActivityType.addEventListener('change', loadActivity);
  filterActivityDate.addEventListener('change', loadActivity);
  clearActivityFiltersBtn.addEventListener('click', clearActivityFilters);
  
  // Botones de exportación
  exportEmployeesExcelBtn.addEventListener('click', exportEmployeesToExcel);
  exportActivityExcelBtn.addEventListener('click', exportActivityToExcel);
  
  // Cargar datos iniciales
  loadEmployeesForManagement();
}

// Cargar empleados para la gestión
function loadEmployeesForManagement() {
  const department = filterEmployeeDepartment.value;
  const hotel = filterEmployeeHotel.value;
  
  let query = employeesCollection.orderBy('nombre');
  
  if (department) {
    query = query.where('departamento', '==', department);
  }
  
  if (hotel) {
    query = query.where('hotel', '==', hotel);
  }
  
  query.get()
    .then(snapshot => {
      const employees = [];
      snapshot.forEach(doc => {
        employees.push({ id: doc.id, ...doc.data() });
      });
      
      renderEmployees(employees);
    })
    .catch(error => {
      console.error('Error cargando empleados:', error);
      alert('Error al cargar la lista de empleados');
    });
}

// Cargar empleados para el selector de usuario
function loadEmployeesForUserSelect() {
  employeesCollection.orderBy('nombre').get()
    .then(snapshot => {
      // Limpiar selector
      userEmployee.innerHTML = '<option value="">-- Sin vincular --</option>';
      
      snapshot.forEach(doc => {
        const employee = doc.data();
        const option = document.createElement('option');
        option.value = doc.id;
        option.textContent = `${employee.nombre} (${employee.departamento}, ${employee.hotel})`;
        userEmployee.appendChild(option);
      });
    })
    .catch(error => {
      console.error('Error cargando empleados para selector:', error);
    });
}

// Cargar usuarios para la gestión
function loadUsersForManagement() {
  usersCollection.get()
    .then(snapshot => {
      const users = [];
      snapshot.forEach(doc => {
        users.push({ id: doc.id, ...doc.data() });
      });
      
      // Buscar información de empleados vinculados
      const employeePromises = users.map(user => {
        if (user.employeeId) {
          return employeesCollection.doc(user.employeeId).get()
            .then(doc => {
              if (doc.exists) {
                user.employee = doc.data();
              }
              return user;
            });
        } else {
          return Promise.resolve(user);
        }
      });
      
      Promise.all(employeePromises).then(usersWithEmployees => {
        renderUsers(usersWithEmployees);
      });
    })
    .catch(error => {
      console.error('Error cargando usuarios:', error);
      alert('Error al cargar la lista de usuarios');
    });
}

// Cargar usuarios para el filtro de actividad
function loadUsersForActivityFilter() {
  usersCollection.get()
    .then(snapshot => {
      // Limpiar selector
      filterActivityUser.innerHTML = '<option value="">Todos</option>';
      
      snapshot.forEach(doc => {
        const user = doc.data();
        const option = document.createElement('option');
        option.value = doc.id;
        option.textContent = user.email;
        filterActivityUser.appendChild(option);
      });
    })
    .catch(error => {
      console.error('Error cargando usuarios para filtro:', error);
    });
}

// Cargar actividad
function loadActivity() {
  const userId = filterActivityUser.value;
  const activityType = filterActivityType.value;
  const activityDate = filterActivityDate.value;
  
  let query = activityCollection.orderBy('timestamp', 'desc').limit(100);
  
  if (userId) {
    query = query.where('userId', '==', userId);
  }
  
  if (activityType) {
    query = query.where('type', '==', activityType);
  }
  
  if (activityDate) {
    const startDate = new Date(activityDate);
    startDate.setHours(0, 0, 0, 0);
    
    const endDate = new Date(activityDate);
    endDate.setHours(23, 59, 59, 999);
    
    query = query.where('timestamp', '>=', startDate)
                .where('timestamp', '<=', endDate);
  }
  
  query.get()
    .then(snapshot => {
      const activities = [];
      snapshot.forEach(doc => {
        activities.push({ id: doc.id, ...doc.data() });
      });
      
      // Buscar información de usuarios
      const userPromises = activities.map(activity => {
        if (activity.userId) {
          return usersCollection.doc(activity.userId).get()
            .then(doc => {
              if (doc.exists) {
                activity.user = doc.data();
              }
              return activity;
            });
        } else {
          return Promise.resolve(activity);
        }
      });
      
      Promise.all(userPromises).then(activitiesWithUsers => {
        renderActivity(activitiesWithUsers);
      });
    })
    .catch(error => {
      console.error('Error cargando actividad:', error);
      alert('Error al cargar la actividad');
    });
}

// Renderizar lista de empleados
function renderEmployees(employees) {
  employeeContainer.innerHTML = '';
  
  if (employees.length === 0) {
    employeeContainer.innerHTML = '<p class="text-center">No hay empleados que coincidan con los filtros</p>';
    return;
  }
  
  employees.forEach(employee => {
    const card = document.createElement('div');
    card.className = 'task-card employee-card';
    
    card.innerHTML = `
      <div class="employee-header">
        <div>
          <div class="employee-name">${sanitizeHTML(employee.nombre)}</div>
          <div class="employee-position">${sanitizeHTML(employee.cargo || 'Sin cargo')}</div>
        </div>
        <div class="employee-dept">${sanitizeHTML(employee.departamento)} - ${sanitizeHTML(employee.hotel)}</div>
      </div>
      <div class="employee-details">
        <div class="employee-detail">
          <i class="fas fa-phone"></i>
          <span>${sanitizeHTML(employee.telefono || 'Sin teléfono')}</span>
        </div>
        <div class="employee-detail">
          <i class="fas fa-envelope"></i>
          <span>${sanitizeHTML(employee.email || 'Sin email')}</span>
        </div>
      </div>
      ${employee.notas ? `<div class="task-description">${sanitizeHTML(employee.notas)}</div>` : ''}
      <div class="employee-actions">
        <button class="btn btn-warning" onclick="editEmployee('${employee.id}')">
          <i class="fas fa-edit"></i> Editar
        </button>
        <button class="btn btn-primary" onclick="createUserForEmployee('${employee.id}')">
          <i class="fas fa-user-plus"></i> Crear Usuario
        </button>
        <button class="btn btn-danger" onclick="deleteEmployee('${employee.id}')">
          <i class="fas fa-trash"></i> Eliminar
        </button>
      </div>
    `;
    
    employeeContainer.appendChild(card);
  });
}

// Renderizar lista de usuarios
function renderUsers(users) {
  userContainer.innerHTML = '';
  
  if (users.length === 0) {
    userContainer.innerHTML = '<p class="text-center">No hay usuarios registrados</p>';
    return;
  }
  
  users.forEach(user => {
    const card = document.createElement('div');
    card.className = 'task-card user-card';
    
    const roleClass = user.role === 'admin' ? 'role-admin' : 'role-user';
    const roleText = user.role === 'admin' ? 'Administrador' : 'Usuario Estándar';
    
    card.innerHTML = `
      <div class="user-info">
        <div class="user-email">${sanitizeHTML(user.email)}</div>
        <div class="user-role ${roleClass}">${roleText}</div>
        ${user.employee ? `
          <div class="user-employee">
            <i class="fas fa-user-tie"></i> Vinculado a: ${sanitizeHTML(user.employee.nombre)}
          </div>
        ` : ''}
        <div class="user-created">
          Creado: ${formatDate(user.createdAt)}
        </div>
      </div>
      <div class="user-actions">
        <button class="btn btn-warning" onclick="resetUserPassword('${user.id}')">
          <i class="fas fa-key"></i> Reset
        </button>
        <button class="btn btn-danger" onclick="deleteUser('${user.id}')">
          <i class="fas fa-trash"></i> Eliminar
        </button>
      </div>
    `;
    
    userContainer.appendChild(card);
  });
}

// Renderizar tabla de actividad
function renderActivity(activities) {
  activityTableBody.innerHTML = '';
  
  if (activities.length === 0) {
    activityTableBody.innerHTML = '<tr><td colspan="4" class="text-center">No hay registros de actividad</td></tr>';
    return;
  }
  
  activities.forEach(activity => {
    const row = document.createElement('tr');
    
    // Formatear fecha y hora
    const timestamp = activity.timestamp.toDate();
    const formattedDate = timestamp.toLocaleDateString('es-ES', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric'
    });
    const formattedTime = timestamp.toLocaleTimeString('es-ES', {
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit'
    });
    
    // Obtener clase de tipo de actividad
    const typeClass = `activity-type-${activity.type}`;
    
    row.innerHTML = `
      <td class="activity-timestamp">${formattedDate} ${formattedTime}</td>
      <td class="activity-user">${activity.user ? sanitizeHTML(activity.user.email) : 'Usuario desconocido'}</td>
      <td class="activity-action ${typeClass}">${formatActivityType(activity.type)}: ${sanitizeHTML(activity.action)}</td>
      <td class="activity-details">${sanitizeHTML(activity.details || '')}</td>
    `;
    
    activityTableBody.appendChild(row);
  });
}

// Guardar empleado
function saveEmployee() {
  // Validar campos
  if (!employeeName.value.trim()) {
    alert('Por favor introduce el nombre del empleado');
    return;
  }
  
  // Preparar datos
  const employeeData = {
    nombre: employeeName.value.trim(),
    cargo: employeePosition.value.trim(),
    departamento: employeeDepartment.value,
    hotel: employeeHotel.value,
    telefono: employeePhone.value.trim(),
    email: employeeEmail.value.trim(),
    notas: employeeNotes.value.trim(),
    updatedAt: new Date(),
    updatedBy: currentUser.uid
  };
  
  // Si es nuevo empleado
  if (!currentEmployeeId) {
    employeeData.createdAt = new Date();
    employeeData.createdBy = currentUser.uid;
  }
  
  saveEmployeeBtn.disabled = true;
  
  // Guardar en Firestore
  const savePromise = currentEmployeeId
    ? employeesCollection.doc(currentEmployeeId).update(employeeData)
    : employeesCollection.add(employeeData);
  
  savePromise
    .then(result => {
      // Si es nuevo empleado, capturar el ID para crear usuario
      if (!currentEmployeeId && result && result.id) {
        currentEmployeeId = result.id;
        createUserFromEmployeeBtn.disabled = false;
      }
      
      // Registrar actividad
      logActivity('employee', currentEmployeeId ? 'Empleado actualizado' : 'Empleado creado', 
        `${employeeData.nombre} (${employeeData.departamento}, ${employeeData.hotel})`);
      
      resetEmployeeForm();
      loadEmployeesForManagement();
      saveEmployeeBtn.disabled = false;
      
      alert(currentEmployeeId ? 'Empleado actualizado correctamente' : 'Empleado creado correctamente');
    })
    .catch(error => {
      console.error('Error guardando empleado:', error);
      alert('Error al guardar el empleado');
      saveEmployeeBtn.disabled = false;
    });
}

// Resetear formulario de empleado
function resetEmployeeForm() {
  employeeName.value = '';
  employeePosition.value = '';
  employeeDepartment.value = 'recepcion';
  employeeHotel.value = 'Wave';
  employeePhone.value = '';
  employeeEmail.value = '';
  employeeNotes.value = '';
  currentEmployeeId = null;
  saveEmployeeBtn.innerHTML = '<i class="fas fa-save"></i> Guardar Empleado';
  createUserFromEmployeeBtn.disabled = true;
}

// Editar empleado
function editEmployee(employeeId) {
  employeesCollection.doc(employeeId).get()
    .then(doc => {
      if (doc.exists) {
        const employee = doc.data();
        
        employeeName.value = employee.nombre || '';
        employeePosition.value = employee.cargo || '';
        employeeDepartment.value = employee.departamento || 'recepcion';
        employeeHotel.value = employee.hotel || 'Wave';
        employeePhone.value = employee.telefono || '';
        employeeEmail.value = employee.email || '';
        employeeNotes.value = employee.notas || '';
        
        currentEmployeeId = employeeId;
        saveEmployeeBtn.textContent = '<i class="fas fa-save"></i> Actualizar Empleado';
        createUserFromEmployeeBtn.disabled = false;
        
        // Desplazar hasta el formulario
        document.querySelector('#empleadosTab .form-container').scrollIntoView({ behavior: 'smooth' });
      } else {
        alert('No se encontró el empleado');
      }
    })
    .catch(error => {
      console.error('Error obteniendo empleado:', error);
      alert('Error al cargar el empleado');
    });
}

// Eliminar empleado
function deleteEmployee(employeeId) {
  if (confirm('¿Estás seguro de que deseas eliminar este empleado? Esta acción no se puede deshacer.')) {
    employeesCollection.doc(employeeId).delete()
      .then(() => {
        // Comprobar si el empleado estaba vinculado a un usuario
        usersCollection.where('employeeId', '==', employeeId).get()
          .then(snapshot => {
            if (!snapshot.empty) {
              alert('ATENCIÓN: Este empleado estaba vinculado a uno o más usuarios del sistema. La vinculación ha sido eliminada, pero las cuentas de usuario permanecen.');
              
              // Actualizar usuarios vinculados
              const batch = db.batch();
              snapshot.forEach(doc => {
                batch.update(doc.ref, { employeeId: null });
              });
              
              return batch.commit();
            }
            return null;
          })
          .then(() => {
            // Registrar actividad
            logActivity('employee', 'Empleado eliminado', `ID: ${employeeId}`);
            
            if (currentEmployeeId === employeeId) {
              resetEmployeeForm();
            }
            loadEmployeesForManagement();
          });
      })
      .catch(error => {
        console.error('Error eliminando empleado:', error);
        alert('Error al eliminar el empleado');
      });
  }
}

// Mostrar formulario para crear usuario
function showCreateUserForm() {
  // Cambiar a la pestaña de usuarios
  tabs.forEach(t => t.classList.remove('active'));
  tabContents.forEach(content => content.classList.remove('active'));
  
  document.querySelector('.tab[data-tab="usuarios"]').classList.add('active');
  document.getElementById('usuariosTab').classList.add('active');
  
  // Cargar datos
  loadUsersForManagement();
  loadEmployeesForUserSelect();
  
  // Si hay un empleado seleccionado, pre-llenamos el campo
  if (currentEmployeeId) {
    employeesCollection.doc(currentEmployeeId).get()
      .then(doc => {
        if (doc.exists) {
          const employee = doc.data();
          userEmail.value = employee.email || '';
          userEmployee.value = currentEmployeeId;
        }
      });
  }
  
  // Enfocar el campo de email
  setTimeout(() => {
    userEmail.focus();
  }, 300);
}

// Crear usuario para empleado específico
function createUserForEmployee(employeeId) {
  currentEmployeeId = employeeId;
  showCreateUserForm();
}

// Guardar usuario
function saveUser() {
  // Validar campos
  if (!userEmail.value.trim()) {
    alert('Por favor introduce un email para el usuario');
    return;
  }
  
  if (!userPassword.value) {
    alert('Por favor introduce una contraseña');
    return;
  }
  
  if (userPassword.value.length < 6) {
    alert('La contraseña debe tener al menos 6 caracteres');
    return;
  }
  
  const email = userEmail.value.trim();
  const password = userPassword.value;
  const role = userRole.value;
  const employeeId = userEmployee.value || null;
  
  saveUserBtn.disabled = true;
  
  // Crear usuario en Firebase Auth
  auth.createUserWithEmailAndPassword(email, password)
    .then(userCredential => {
      const uid = userCredential.user.uid;
      
      // Guardar datos adicionales en Firestore
      return usersCollection.doc(uid).set({
        email: email,
        role: role,
        employeeId: employeeId,
        createdAt: new Date(),
        createdBy: currentUser.uid
      });
    })
    .then(() => {
      // Registrar actividad
      logActivity('user', 'Usuario creado', `Email: ${email}, Rol: ${role}`);
      
      resetUserForm();
      loadUsersForManagement();
      saveUserBtn.disabled = false;
      
      alert('Usuario creado correctamente');
    })
    .catch(error => {
      console.error('Error creando usuario:', error);
      
      let errorMessage = 'Error al crear el usuario';
      if (error.code === 'auth/email-already-in-use') {
        errorMessage = 'El email ya está en uso por otra cuenta';
      } else if (error.code === 'auth/invalid-email') {
        errorMessage = 'El formato del email no es válido';
      }
      
      alert(errorMessage);
      saveUserBtn.disabled = false;
    });
}

// Resetear formulario de usuario
function resetUserForm() {
  userEmail.value = '';
  userPassword.value = '';
  userRole.value = 'user';
  userEmployee.value = '';
}

// Resetear contraseña de usuario
function resetUserPassword(userId) {
  if (!confirm('¿Estás seguro de que deseas enviar un correo de restablecimiento de contraseña a este usuario?')) {
    return;
  }
  
  usersCollection.doc(userId).get()
    .then(doc => {
      if (doc.exists) {
        const user = doc.data();
        
        // Enviar email de restablecimiento
        return auth.sendPasswordResetEmail(user.email);
      } else {
        throw new Error('Usuario no encontrado');
      }
    })
    .then(() => {
      alert('Se ha enviado un correo de restablecimiento de contraseña al usuario');
      
      // Registrar actividad
      logActivity('user', 'Restablecimiento de contraseña', `ID: ${userId}`);
    })
    .catch(error => {
      console.error('Error restableciendo contraseña:', error);
      alert('Error al enviar el correo de restablecimiento de contraseña');
    });
}

// Eliminar usuario
function deleteUser(userId) {
  if (confirm('¿Estás seguro de que deseas eliminar este usuario? Esta acción no se puede deshacer.')) {
    // Primero obtener datos del usuario para el registro de actividad
    usersCollection.doc(userId).get()
      .then(doc => {
        const userData = doc.exists ? doc.data() : { email: 'Desconocido' };
        
        // Eliminar al usuario de Firestore
        return usersCollection.doc(userId).delete()
          .then(() => {
            // Registrar actividad
            logActivity('user', 'Usuario eliminado', `Email: ${userData.email}`);
            
            loadUsersForManagement();
            alert('Usuario eliminado correctamente. NOTA: Para eliminarlo completamente, debes usar la consola de Firebase Authentication.');
          });
      })
      .catch(error => {
        console.error('Error eliminando usuario:', error);
        alert('Error al eliminar el usuario');
      });
  }
}

// Limpiar filtros de empleados
function clearEmployeeFilters() {
  filterEmployeeDepartment.value = '';
  filterEmployeeHotel.value = '';
  loadEmployeesForManagement();
}

// Limpiar filtros de actividad
function clearActivityFilters() {
  filterActivityUser.value = '';
  filterActivityType.value = '';
  filterActivityDate.value = '';
  loadActivity();
}

// Exportar empleados a Excel
function exportEmployeesToExcel() {
  const department = filterEmployeeDepartment.value;
  const hotel = filterEmployeeHotel.value;
  
  let query = employeesCollection.orderBy('nombre');
  
  if (department) {
    query = query.where('departamento', '==', department);
  }
  
  if (hotel) {
    query = query.where('hotel', '==', hotel);
  }
  
  query.get()
    .then(snapshot => {
      if (snapshot.empty) {
        alert('No hay empleados para exportar');
        return;
      }
      
      const employees = [];
      snapshot.forEach(doc => {
        const employee = doc.data();
        employees.push({
          'Nombre': employee.nombre,
          'Cargo': employee.cargo || '',
          'Departamento': employee.departamento,
          'Hotel': employee.hotel,
          'Teléfono': employee.telefono || '',
          'Email': employee.email || '',
          'Notas': employee.notas || '',
          'Creado': formatDate(employee.createdAt)
        });
      });
      
      // Crear libro Excel
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.json_to_sheet(employees);
      
      // Añadir hoja al libro
      XLSX.utils.book_append_sheet(wb, ws, 'Empleados');
      
      // Generar el archivo Excel
      const date = new Date().toISOString().split('T')[0];
      XLSX.writeFile(wb, `Empleados_${date}.xlsx`);
      
      // Registrar actividad
      logActivity('employee', 'Exportar a Excel', `${employees.length} empleados exportados`);
    })
    .catch(error => {
      console.error('Error exportando a Excel:', error);
      alert('Error al exportar a Excel');
    });
}

// Exportar actividad a Excel
function exportActivityToExcel() {
  const userId = filterActivityUser.value;
  const activityType = filterActivityType.value;
  const activityDate = filterActivityDate.value;
  
  let query = activityCollection.orderBy('timestamp', 'desc').limit(1000);
  
  if (userId) {
    query = query.where('userId', '==', userId);
  }
  
  if (activityType) {
    query = query.where('type', '==', activityType);
  }
  
  if (activityDate) {
    const startDate = new Date(activityDate);
    startDate.setHours(0, 0, 0, 0);
    
    const endDate = new Date(activityDate);
    endDate.setHours(23, 59, 59, 999);
    
    query = query.where('timestamp', '>=', startDate)
                .where('timestamp', '<=', endDate);
  }
  
  query.get()
    .then(snapshot => {
      if (snapshot.empty) {
        alert('No hay actividad para exportar');
        return;
      }
      
      // Crear promesas para obtener información de usuarios
      const activities = [];
      const userPromises = [];
      
      snapshot.forEach(doc => {
        const activity = doc.data();
        
        // Solo añadir si tenemos el usuario
        if (activity.userId) {
          userPromises.push(
            usersCollection.doc(activity.userId).get()
              .then(userDoc => {
                const userEmail = userDoc.exists ? userDoc.data().email : 'Desconocido';
                
                // Formatear fecha
                const timestamp = activity.timestamp.toDate();
                const formattedDate = timestamp.toLocaleDateString('es-ES');
                const formattedTime = timestamp.toLocaleTimeString('es-ES');
                
                activities.push({
                  'Fecha': formattedDate,
                  'Hora': formattedTime,
                  'Usuario': userEmail,
                  'Tipo': formatActivityType(activity.type),
                  'Acción': activity.action,
                  'Detalles': activity.details || ''
                });
              })
          );
        } else {
          // Si no hay usuario, añadir la actividad sin nombre de usuario
          const timestamp = activity.timestamp.toDate();
          const formattedDate = timestamp.toLocaleDateString('es-ES');
          const formattedTime = timestamp.toLocaleTimeString('es-ES');
          
          activities.push({
            'Fecha': formattedDate,
            'Hora': formattedTime,
            'Usuario': 'Desconocido',
            'Tipo': formatActivityType(activity.type),
            'Acción': activity.action,
            'Detalles': activity.details || ''
          });
        }
      });
      
      // Esperar a que todas las promesas se resuelvan
      return Promise.all(userPromises).then(() => activities);
    })
    .then(activities => {
      if (activities.length === 0) {
        alert('No hay actividad para exportar');
        return;
      }
      
      // Crear libro Excel
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.json_to_sheet(activities);
      
      // Añadir hoja al libro
      XLSX.utils.book_append_sheet(wb, ws, 'Actividad');
      
      // Generar el archivo Excel
      const date = new Date().toISOString().split('T')[0];
      XLSX.writeFile(wb, `Actividad_${date}.xlsx`);
      
      // Registrar actividad
      logActivity('activity', 'Exportar a Excel', `${activities.length} registros exportados`);
    })
    .catch(error => {
      console.error('Error exportando a Excel:', error);
      alert('Error al exportar a Excel');
    });
}

// Registrar actividad en el sistema
function logActivity(type, action, details = '') {
  // Crear objeto de actividad
  const activityData = {
    type: type,
    action: action,
    details: details,
    timestamp: new Date(),
    userId: currentUser.uid
  };
  
  // Guardar en Firestore
  activityCollection.add(activityData)
    .catch(error => {
      console.error('Error registrando actividad:', error);
    });
}

// Formatear tipo de actividad
function formatActivityType(type) {
  switch (type) {
    case 'login': return 'Acceso';
    case 'task': return 'Tarea';
    case 'order': return 'Pedido';
    case 'chemical': return 'Químico';
    case 'shift': return 'Turno';
    case 'employee': return 'Personal';
    case 'user': return 'Usuario';
    case 'activity': return 'Actividad';
    default: return type;
  }
}

// Exponer funciones al ámbito global
window.editEmployee = editEmployee;
window.deleteEmployee = deleteEmployee;
window.createUserForEmployee = createUserForEmployee;
window.resetUserPassword = resetUserPassword;
window.deleteUser = deleteUser;

// Añadir a onAuthStateChanged para registrar login
const originalOnAuthStateChanged = auth.onAuthStateChanged;
auth.onAuthStateChanged = callback => {
  return originalOnAuthStateChanged.call(auth, user => {
    if (user && !sessionStorage.getItem('logged_in')) {
      // Registrar actividad de login
      sessionStorage.setItem('logged_in', 'true');
      
      // Usar setTimeout para asegurar que la colección esté disponible
      setTimeout(() => {
        const activityData = {
          type: 'login',
          action: 'Inicio de sesión',
          timestamp: new Date(),
          userId: user.uid
        };
        
        activityCollection.add(activityData)
          .catch(error => {
            console.error('Error registrando actividad de login:', error);
          });
      }, 1000);
    } else if (!user) {
      sessionStorage.removeItem('logged_in');
    }
    
    return callback(user);
  });
};

// Modificar funciones existentes para registrar actividad

// Modificar saveTask
const originalSaveTask = saveTaskBtn.onclick;
saveTaskBtn.onclick = () => {
  const isUpdate = currentTaskId ? true : false;
  
  // Llamar función original
  const result = originalSaveTask.call(saveTaskBtn);
  
  // Si hay título, registrar la actividad
  if (taskTitle.value) {
    logActivity('task', isUpdate ? 'Tarea actualizada' : 'Tarea creada', taskTitle.value);
  }
  
  return result;
};

// Modificar saveOrder
const originalSaveOrder = saveOrderBtn.onclick;
saveOrderBtn.onclick = () => {
  const isUpdate = currentOrderId ? true : false;
  
  // Llamar función original
  const result = originalSaveOrder.call(saveOrderBtn);
  
  // Si hay título, registrar la actividad
  if (orderTitle.value) {
    logActivity('order', isUpdate ? 'Pedido actualizado' : 'Pedido creado', orderTitle.value);
  }
  
  return result;
};

// Modificar updateOrderStatus
const originalUpdateOrderStatus = updateOrderStatus;
updateOrderStatus = (orderId, status, reason = '') => {
  // Llamar función original
  const result = originalUpdateOrderStatus(orderId, status, reason);
  
  // Registrar actividad
  logActivity('order', `Estado cambiado a: ${status}`, `ID: ${orderId}${reason ? ', Razón: ' + reason : ''}`);
  
  return result;
};

// Inicializar módulo de personal cuando se carga
document.addEventListener('DOMContentLoaded', () => {
  // Verificar si existe el módulo de personal
  if (document.getElementById('personalModule')) {
    // Solo inicializar si el usuario es admin
    auth.onAuthStateChanged(user => {
      if (user) {
        usersCollection.doc(user.uid).get().then(doc => {
          if (doc.exists && doc.data().role === 'admin') {
            initPersonalModule();
          }
        });
      }
    });
  }
});




        // ----------- MÓDULO: PEDIDOS QUÍMICOS -----------

// Lista predefinida de productos químicos
const chemicalProducts = [
  { id: 1, name: "SAL DESCALSFICADOR PASTILLAS 25KG", unit: "kg" },
  { id: 2, name: "HIPOCLORITO PISCINAS", unit: "l" },
  { id: 3, name: "DISMINUIDOR PH LIQUIDO AQUA PEDROSA 23KG", unit: "kg" },
  { id: 4, name: "ACIDO CLORHIDICO 32% CONS.HUMANO 23KG", unit: "kg" },
  { id: 5, name: "REACTIVO FOTOMETRO DPD-1 C/250UN", unit: "un" },
  { id: 6, name: "REACTIVO FOTOMETRO DPD-3 C/250UN", unit: "un" },
  { id: 7, name: "REACTIVO FOTOMETRO PH (PHENOL RED) C/250UN", unit: "un" },
  { id: 8, name: "LEJIA ALIMENTARIA 40GR/L 22KG", unit: "kg" },
  { id: 9, name: "ANTIINCRUSTANTE QUIMIFOS GFA 20L", unit: "l" },
  { id: 10, name: "ESTABILIZANTE CTX-400", unit: "kg" },
  { id: 11, name: "DESENGRASANTE CTX-75", unit: "l" },
  { id: 12, name: "CLORO GRANULADO CTX-300", unit: "kg" },
  { id: 13, name: "BROMO TABLETAS CUBO 20KG", unit: "kg" },
  { id: 14, name: "COAGULANTE GOLDENFLOK GFA 5KG", unit: "kg" },
  { id: 15, name: "ALGIBLACK GFA 5KG", unit: "kg" },
  { id: 16, name: "REACTIVO ISOCIANURICO", unit: "un" },
  { id: 17, name: "NEUTRALIZANTE CTX-12", unit: "kg" }
];

// Elementos DOM del módulo de químicos
const chemicalTitle = document.getElementById('chemicalTitle');
const chemicalHotel = document.getElementById('chemicalHotel');
const chemicalNotes = document.getElementById('chemicalNotes');
const chemicalProductsList = document.getElementById('chemicalProductsList');
const saveChemicalBtn = document.getElementById('saveChemical');
const shareWhatsAppBtn = document.getElementById('shareWhatsApp');
const chemicalContainer = document.getElementById('chemicalContainer');
const filterChemicalHotel = document.getElementById('filterChemicalHotel');
const clearChemicalFiltersBtn = document.getElementById('clearChemicalFilters');
const exportChemicalExcelBtn = document.getElementById('exportChemicalExcel');

// Colección de Firestore para pedidos químicos
const chemicalsCollection = db.collection('chemicals');

// Cargar pedidos químicos
function loadChemicals() {
  chemicalsCollection.orderBy('createdAt', 'desc').get()
    .then(snapshot => {
      const chemicals = [];
      snapshot.forEach(doc => {
        chemicals.push({ id: doc.id, ...doc.data() });
      });
      applyChemicalFilters(chemicals);
    })
    .catch(error => {
      console.error('Error cargando pedidos químicos:', error);
      alert('Error al cargar los pedidos químicos');
    });
}

// Inicializar lista de productos
// Inicializar lista de productos
function initChemicalProductsList() {
  chemicalProductsList.innerHTML = '';
  
  chemicalProducts.forEach(product => {
    const row = document.createElement('tr');
    
    // Crear celda para el nombre del producto
    const nameCell = document.createElement('td');
    nameCell.className = 'product-col';
    nameCell.textContent = product.name;
    
    // Crear celda para cantidad Wave
    const waveCell = document.createElement('td');
    waveCell.className = 'qty-col';
    const waveInput = document.createElement('input');
    waveInput.type = 'number';
    waveInput.className = 'form-control wave-qty';
    waveInput.setAttribute('data-product-id', product.id);
    waveInput.min = 0;
    waveInput.value = 0;
    waveCell.appendChild(waveInput);
    
    // Crear celda para cantidad Sky
    const skyCell = document.createElement('td');
    skyCell.className = 'qty-col';
    const skyInput = document.createElement('input');
    skyInput.type = 'number';
    skyInput.className = 'form-control sky-qty';
    skyInput.setAttribute('data-product-id', product.id);
    skyInput.min = 0;
    skyInput.value = 0;
    skyCell.appendChild(skyInput);
    
    // Crear celda para unidad
    const unitCell = document.createElement('td');
    unitCell.className = 'unit-col';
    unitCell.textContent = product.unit;
    
    // Añadir todas las celdas a la fila
    row.appendChild(nameCell);
    row.appendChild(waveCell);
    row.appendChild(skyCell);
    row.appendChild(unitCell);
    
    // Añadir la fila a la tabla
    chemicalProductsList.appendChild(row);
  });
}

// Guardar pedido químico
saveChemicalBtn.addEventListener('click', () => {
  // Validar campos
  if (!chemicalTitle.value.trim()) {
    alert('Por favor introduce un título para el pedido');
    return;
  }

  // Recopilar cantidades de productos
  const productQuantities = [];
  const waveInputs = document.querySelectorAll('.wave-qty');
  const skyInputs = document.querySelectorAll('.sky-qty');
  
  let hasProducts = false;
  
  for (let i = 0; i < waveInputs.length; i++) {
    const productId = parseInt(waveInputs[i].getAttribute('data-product-id'));
    const waveQty = parseInt(waveInputs[i].value) || 0;
    const skyQty = parseInt(skyInputs[i].value) || 0;
    
    if (waveQty > 0 || skyQty > 0) {
      hasProducts = true;
      const product = chemicalProducts.find(p => p.id === productId);
      productQuantities.push({
        productId,
        name: product.name,
        unit: product.unit,
        waveQty,
        skyQty
      });
    }
  }
  
  if (!hasProducts) {
    alert('Por favor introduce al menos un producto con cantidad mayor a cero');
    return;
  }

  // Preparar datos
  const chemicalData = {
    title: chemicalTitle.value.trim(),
    hotel: chemicalHotel.value,
    notes: chemicalNotes.value.trim(),
    products: productQuantities,
    createdAt: new Date(),
    createdBy: currentUser.uid,
    createdByEmail: currentUser.email,
    status: 'Pendiente'
  };

  saveChemicalBtn.disabled = true;

  // Guardar en Firestore
  chemicalsCollection.add(chemicalData)
    .then(() => {
      resetChemicalForm();
      loadChemicals();
      saveChemicalBtn.disabled = false;
      alert('Pedido de químicos guardado correctamente');
    })
    .catch(error => {
      console.error('Error guardando pedido químico:', error);
      alert('Error al guardar el pedido');
      saveChemicalBtn.disabled = false;
    });
});

// Compartir por WhatsApp
shareWhatsAppBtn.addEventListener('click', () => {
  // Validar campos
  if (!chemicalTitle.value.trim()) {
    alert('Por favor introduce un título para el pedido');
    return;
  }

  // Recopilar cantidades de productos
  const waveInputs = document.querySelectorAll('.wave-qty');
  const skyInputs = document.querySelectorAll('.sky-qty');
  
  let hasProducts = false;
  let messageText = `*${chemicalTitle.value.trim()}*\n\n`;
  
  if (chemicalHotel.value !== 'Ambos') {
    messageText += `Hotel: ${chemicalHotel.value}\n\n`;
  }
  
  messageText += "Productos:\n";
  
  for (let i = 0; i < waveInputs.length; i++) {
    const productId = parseInt(waveInputs[i].getAttribute('data-product-id'));
    const waveQty = parseInt(waveInputs[i].value) || 0;
    const skyQty = parseInt(skyInputs[i].value) || 0;
    
    if (waveQty > 0 || skyQty > 0) {
      hasProducts = true;
      const product = chemicalProducts.find(p => p.id === productId);
      
      if (chemicalHotel.value === 'Ambos') {
        messageText += `- ${product.name}: Wave=${waveQty} ${product.unit}, Sky=${skyQty} ${product.unit}\n`;
      } else if (chemicalHotel.value === 'Wave') {
        messageText += `- ${product.name}: ${waveQty} ${product.unit}\n`;
      } else {
        messageText += `- ${product.name}: ${skyQty} ${product.unit}\n`;
      }
    }
  }
  
  if (!hasProducts) {
    alert('Por favor introduce al menos un producto con cantidad mayor a cero');
    return;
  }
  
  if (chemicalNotes.value.trim()) {
    messageText += `\nNotas: ${chemicalNotes.value.trim()}`;
  }
  
  // Codificar mensaje para URL
  const encodedMessage = encodeURIComponent(messageText);
  
  // Abrir WhatsApp
  window.open(`https://wa.me/?text=${encodedMessage}`, '_blank');
});

// Resetear formulario de químicos
function resetChemicalForm() {
  chemicalTitle.value = '';
  chemicalHotel.value = 'Wave';
  chemicalNotes.value = '';
  initChemicalProductsList();
}

// Filtrar pedidos químicos
function applyChemicalFilters(chemicals) {
  const hotelFilter = filterChemicalHotel.value;
  
  let filteredChemicals = [...chemicals];
  
  if (hotelFilter) {
    filteredChemicals = filteredChemicals.filter(chemical => 
      chemical.hotel === hotelFilter || chemical.hotel === 'Ambos'
    );
  }
  
  renderChemicals(filteredChemicals);
}

// Renderizar lista de pedidos químicos
// Renderizar lista de pedidos químicos
function renderChemicals(chemicals) {
  chemicalContainer.innerHTML = '';

  if (chemicals.length === 0) {
    chemicalContainer.innerHTML = '<p class="text-center">No hay pedidos químicos que coincidan con los filtros</p>';
    return;
  }

  chemicals.forEach(chemical => {
    const card = document.createElement('div');
    card.className = 'task-card';

    const statusClass = `status-${chemical.status ? chemical.status.toLowerCase() : 'pendiente'}`;

    // Filtrar productos con cantidades mayores a cero
    const relevantProducts = chemical.products.filter(product => 
      (chemical.hotel === 'Wave' && product.waveQty > 0) || 
      (chemical.hotel === 'Sky' && product.skyQty > 0) || 
      (chemical.hotel === 'Ambos' && (product.waveQty > 0 || product.skyQty > 0))
    );

    // Crear el HTML para los productos
    let productsHtml = '<div class="chemical-products">';
    
    relevantProducts.forEach(product => {
      let qtyText = '';
      
      if (chemical.hotel === 'Ambos') {
        if (product.waveQty > 0 && product.skyQty > 0) {
          qtyText = `Wave: ${product.waveQty} ${product.unit}, Sky: ${product.skyQty} ${product.unit}`;
        } else if (product.waveQty > 0) {
          qtyText = `Wave: ${product.waveQty} ${product.unit}`;
        } else {
          qtyText = `Sky: ${product.skyQty} ${product.unit}`;
        }
      } else if (chemical.hotel === 'Wave' && product.waveQty > 0) {
        qtyText = `${product.waveQty} ${product.unit}`;
      } else if (chemical.hotel === 'Sky' && product.skyQty > 0) {
        qtyText = `${product.skyQty} ${product.unit}`;
      }
      
      productsHtml += `
        <div class="chemical-product-item">
          <span class="product-name">${sanitizeHTML(product.name)}</span>
          <span class="product-qty">${qtyText}</span>
        </div>
      `;
    });
    
    productsHtml += '</div>';

    card.innerHTML = `
      <div class="task-header">
        <h3 class="task-title">${sanitizeHTML(chemical.title)}</h3>
        <span class="order-status ${statusClass}">${sanitizeHTML(chemical.status || 'Pendiente')}</span>
      </div>
      <div class="task-meta">
        <div class="task-hotel">
          <i class="fas fa-hotel"></i> ${sanitizeHTML(chemical.hotel)}
        </div>
        <div class="task-date">
          <i class="fas fa-calendar-alt"></i> ${formatDate(chemical.createdAt)}
        </div>
      </div>
      ${productsHtml}
      ${chemical.notes ? `<div class="task-description">${sanitizeHTML(chemical.notes)}</div>` : ''}
      <div class="task-actions">
        <button class="btn btn-primary" onclick="shareChemicalWhatsApp('${chemical.id}')">
          <i class="fab fa-whatsapp"></i> Compartir
        </button>
        <button class="btn btn-danger" onclick="deleteChemical('${chemical.id}')">
          <i class="fas fa-trash"></i> Eliminar
        </button>
      </div>
    `;

    chemicalContainer.appendChild(card);
  });
}

// Compartir pedido químico existente por WhatsApp
function shareChemicalWhatsApp(chemicalId) {
  chemicalsCollection.doc(chemicalId).get()
    .then(doc => {
      if (doc.exists) {
        const chemical = doc.data();
        
        let messageText = `*${chemical.title}*\n\n`;
        
        if (chemical.hotel !== 'Ambos') {
          messageText += `Hotel: ${chemical.hotel}\n\n`;
        }
        
        messageText += "Productos:\n";
        
        chemical.products.forEach(product => {
          if (chemical.hotel === 'Ambos') {
            messageText += `- ${product.name}: Wave=${product.waveQty} ${product.unit}, Sky=${product.skyQty} ${product.unit}\n`;
          } else if (chemical.hotel === 'Wave') {
            messageText += `- ${product.name}: ${product.waveQty} ${product.unit}\n`;
          } else {
            messageText += `- ${product.name}: ${product.skyQty} ${product.unit}\n`;
          }
        });
        
        if (chemical.notes) {
          messageText += `\nNotas: ${chemical.notes}`;
        }
        
        // Codificar mensaje para URL
        const encodedMessage = encodeURIComponent(messageText);
        
        // Abrir WhatsApp
        window.open(`https://wa.me/?text=${encodedMessage}`, '_blank');
      } else {
        alert('No se encontró el pedido químico');
      }
    })
    .catch(error => {
      console.error('Error obteniendo pedido químico:', error);
      alert('Error al cargar el pedido químico');
    });
}

// Eliminar pedido químico
function deleteChemical(chemicalId) {
  if (confirm('¿Estás seguro de que deseas eliminar este pedido químico?')) {
    chemicalsCollection.doc(chemicalId).delete()
      .then(() => {
        loadChemicals();
      })
      .catch(error => {
        console.error('Error eliminando pedido químico:', error);
        alert('Error al eliminar el pedido químico');
      });
  }
}

// Eventos de filtros
filterChemicalHotel.addEventListener('change', () => loadChemicals());

clearChemicalFiltersBtn.addEventListener('click', () => {
  filterChemicalHotel.value = '';
  loadChemicals();
});

// Exportar a Excel
exportChemicalExcelBtn.addEventListener('click', () => {
  chemicalsCollection.orderBy('createdAt', 'desc').get()
    .then(snapshot => {
      if (snapshot.empty) {
        alert('No hay pedidos químicos para exportar');
        return;
      }

      const chemicals = [];
      snapshot.forEach(doc => {
        const chemical = doc.data();
        
        // Crear una fila por cada producto en el pedido
        chemical.products.forEach(product => {
          chemicals.push({
            'Título del pedido': chemical.title,
            'Hotel': chemical.hotel,
            'Producto': product.name,
            'Cantidad Wave': product.waveQty,
            'Cantidad Sky': product.skyQty,
            'Unidad': product.unit,
            'Notas': chemical.notes || '',
            'Fecha': formatDate(chemical.createdAt),
            'Creado por': chemical.createdByEmail || 'Desconocido'
          });
        });
      });

      // Crear libro Excel
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.json_to_sheet(chemicals);

      // Añadir hoja al libro
      XLSX.utils.book_append_sheet(wb, ws, 'Pedidos Químicos');

      // Generar el archivo Excel
      const date = new Date().toISOString().split('T')[0];
      XLSX.writeFile(wb, `Pedidos_Quimicos_${date}.xlsx`);
    })
    .catch(error => {
      console.error('Error exportando a Excel:', error);
      alert('Error al exportar a Excel');
    });
});

// ----------- MÓDULO: TURNOS -----------

// Referencias a elementos DOM del módulo de turnos
const prevWeekBtn = document.getElementById('prevWeek');
const nextWeekBtn = document.getElementById('nextWeek');
const currentWeekDisplay = document.getElementById('currentWeekDisplay');
const scheduleBody = document.getElementById('scheduleBody');
const filterTurnoDepartamento = document.getElementById('filterTurnoDepartamento');
const filterTurnoHotel = document.getElementById('filterTurnoHotel');
const addShiftBtn = document.getElementById('addShiftBtn');
const exportScheduleBtn = document.getElementById('exportScheduleBtn');
const editShiftForm = document.getElementById('editShiftForm');
const shiftEmployee = document.getElementById('shiftEmployee');
const shiftDate = document.getElementById('shiftDate');
const shiftType = document.getElementById('shiftType');
const shiftNotes = document.getElementById('shiftNotes');
const saveShiftBtn = document.getElementById('saveShift');
const cancelEditShiftBtn = document.getElementById('cancelEditShift');

// Colección de Firestore para turnos
const shiftsCollection = db.collection('shifts');
const employeesCollection = db.collection('employees');

// Variables para el calendario
let currentWeekStart = null;
let currentEmployees = [];
let currentShifts = [];
let editingShiftId = null;

// Inicializar el módulo de turnos
function initTurnosModule() {
  // Configurar la semana actual
  const today = new Date();
  const dayOfWeek = today.getDay() || 7; // 0 es domingo, hacer que sea 7
  const diff = today.getDate() - dayOfWeek + 1; // Ajustar al lunes
  currentWeekStart = new Date(today.setDate(diff));
  currentWeekStart.setHours(0, 0, 0, 0);
  
  // Actualizar visualización de la semana
  updateWeekDisplay();
  
  // Cargar empleados y turnos
  loadEmployees().then(() => {
    loadShifts();
  });
  
  // Configurar eventos de los botones de navegación
  prevWeekBtn.addEventListener('click', () => {
    currentWeekStart.setDate(currentWeekStart.getDate() - 7);
    updateWeekDisplay();
    loadShifts();
  });
  
  nextWeekBtn.addEventListener('click', () => {
    currentWeekStart.setDate(currentWeekStart.getDate() + 7);
    updateWeekDisplay();
    loadShifts();
  });
  
  // Configurar eventos de filtros
  filterTurnoDepartamento.addEventListener('change', loadShifts);
  filterTurnoHotel.addEventListener('change', loadShifts);
  
  // Configurar botón de nuevo turno
  addShiftBtn.addEventListener('click', () => {
    // Resetear y mostrar formulario
    editingShiftId = null;
    shiftDate.value = new Date().toISOString().split('T')[0];
    shiftType.value = 'morning';
    shiftNotes.value = '';
    editShiftForm.style.display = 'block';
    editShiftForm.scrollIntoView({ behavior: 'smooth' });
  });
  
  // Configurar botones del formulario de edición
  saveShiftBtn.addEventListener('click', saveShift);
  cancelEditShiftBtn.addEventListener('click', () => {
    editShiftForm.style.display = 'none';
  });
  
  // Configurar botón de exportar
  exportScheduleBtn.addEventListener('click', exportSchedule);
}

// Actualizar la visualización de la semana actual
// Actualizar la visualización de la semana actual
function updateWeekDisplay() {
  const endOfWeek = new Date(currentWeekStart);
  endOfWeek.setDate(endOfWeek.getDate() + 6);
  
  // Formatear fecha en formato dd/mm
  const formatDate = (date) => {
    return `${String(date.getDate()).padStart(2, '0')}/${String(date.getMonth() + 1).padStart(2, '0')}`;
  };
  
  currentWeekDisplay.textContent = `${formatDate(currentWeekStart)} - ${formatDate(endOfWeek)}, ${currentWeekStart.getFullYear()}`;
  
  // Actualizar las fechas en las celdas de cabecera
  const dateHeaderCells = document.querySelectorAll('.date-row th:not(:first-child)');
  for (let i = 0; i < dateHeaderCells.length && i < 7; i++) {
    const cellDate = new Date(currentWeekStart);
    cellDate.setDate(cellDate.getDate() + i);
    dateHeaderCells[i].textContent = formatDate(cellDate);
  }
}

// Cargar empleados
function loadEmployees() {
  const departamento = filterTurnoDepartamento.value;
  const hotel = filterTurnoHotel.value;
  
  let query = employeesCollection.orderBy('nombre');
  
  if (departamento !== 'todos') {
    query = query.where('departamento', '==', departamento);
  }
  
  if (hotel !== 'todos') {
    query = query.where('hotel', '==', hotel);
  }
  
  return query.get()
    .then(snapshot => {
      currentEmployees = [];
      snapshot.forEach(doc => {
        currentEmployees.push({ id: doc.id, ...doc.data() });
      });
      
      // Llenar el selector de empleados
      populateEmployeeSelect();
      
      return currentEmployees;
    })
    .catch(error => {
      console.error('Error cargando empleados:', error);
      alert('Error al cargar la lista de empleados');
    });
}

// Llenar el selector de empleados
function populateEmployeeSelect() {
  shiftEmployee.innerHTML = '';
  
  currentEmployees.forEach(employee => {
    const option = document.createElement('option');
    option.value = employee.id;
    option.textContent = `${employee.nombre} (${employee.departamento}, ${employee.hotel})`;
    shiftEmployee.appendChild(option);
  });
}

// Cargar turnos para la semana actual
function loadShifts() {
  const departamento = filterTurnoDepartamento.value;
  const hotel = filterTurnoHotel.value;
  
  const weekEnd = new Date(currentWeekStart);
  weekEnd.setDate(weekEnd.getDate() + 7);
  
  let query = shiftsCollection
    .where('fecha', '>=', currentWeekStart)
    .where('fecha', '<', weekEnd);
  
  query.get()
    .then(snapshot => {
      currentShifts = [];
      snapshot.forEach(doc => {
        currentShifts.push({ id: doc.id, ...doc.data() });
      });
      
      // Filtrar turnos por departamento y hotel si es necesario
      if (departamento !== 'todos' || hotel !== 'todos') {
        return Promise.all(
          currentShifts.map(shift => 
            employeesCollection.doc(shift.empleadoId).get()
              .then(doc => {
                if (doc.exists) {
                  const employee = doc.data();
                  shift.employee = employee;
                  
                  // Filtrar por departamento y hotel
                  const deptMatch = departamento === 'todos' || employee.departamento === departamento;
                  const hotelMatch = hotel === 'todos' || employee.hotel === hotel;
                  return deptMatch && hotelMatch ? shift : null;
                }
                return null;
              })
          )
        ).then(shifts => {
          currentShifts = shifts.filter(shift => shift !== null);
          renderSchedule();
        });
      } else {
        renderSchedule();
        return null;
      }
    })
    .catch(error => {
      console.error('Error cargando turnos:', error);
      alert('Error al cargar los turnos');
    });
}

// Renderizar el calendario de turnos
function renderSchedule() {
  scheduleBody.innerHTML = '';
  
  // Agrupar turnos por empleado
  const shiftsByEmployee = {};
  
  currentEmployees.forEach(employee => {
    shiftsByEmployee[employee.id] = {
      employee,
      shifts: Array(7).fill(null) // Un espacio para cada día de la semana
    };
  });
  
  // Asignar turnos a sus días correspondientes
  currentShifts.forEach(shift => {
    const shiftDate = shift.fecha instanceof Date ? shift.fecha : shift.fecha.toDate();
    const diffDays = Math.floor((shiftDate - currentWeekStart) / (24 * 60 * 60 * 1000));
    
    if (diffDays >= 0 && diffDays < 7 && shiftsByEmployee[shift.empleadoId]) {
      shiftsByEmployee[shift.empleadoId].shifts[diffDays] = shift;
    }
  });
  
  // Crear filas para cada empleado
  Object.values(shiftsByEmployee).forEach(({ employee, shifts }) => {
    const row = document.createElement('tr');
    
    // Celda del empleado
    const employeeCell = document.createElement('td');
    employeeCell.className = 'employee-col';
    employeeCell.innerHTML = `
      <div class="employee-name">${sanitizeHTML(employee.nombre)}</div>
      <div class="employee-dept">${sanitizeHTML(employee.departamento)}</div>
    `;
    row.appendChild(employeeCell);
    
    // Celdas para cada día
    for (let i = 0; i < 7; i++) {
      const cell = document.createElement('td');
      if (i >= 5) cell.className = 'weekend'; // Marcar fines de semana
      
      const shift = shifts[i];
      if (shift) {
        // Formatear el turno
        const shiftDiv = document.createElement('div');
        shiftDiv.className = `shift shift-${shift.tipo}`;
        
        let shiftText = '';
        switch (shift.tipo) {
          case 'morning': shiftText = 'Mañana (7-15h)'; break;
          case 'afternoon': shiftText = 'Tarde (15-23h)'; break;
          case 'night': shiftText = 'Noche (23-7h)'; break;
          case 'off': shiftText = 'Descanso'; break;
          case 'vacation': shiftText = 'Vacaciones'; break;
        }
        
        shiftDiv.innerHTML = shiftText;
        shiftDiv.addEventListener('click', () => editShift(shift.id));
        
        cell.appendChild(shiftDiv);
      } else {
        // Celda vacía, permite añadir turno
        cell.addEventListener('click', () => {
  // Calcular fecha exacta para este día de la semana
  const date = new Date(currentWeekStart);
  date.setDate(date.getDate() + i);
  
  // Asegurarse de que la fecha está en UTC y se mantiene el día correcto
  const year = date.getFullYear();
  const month = date.getMonth();
  const day = date.getDate();
  
  // Formato YYYY-MM-DD para el input date (asegurando números de dos dígitos)
  const formattedMonth = (month + 1).toString().padStart(2, '0');
  const formattedDay = day.toString().padStart(2, '0');
  const dateString = `${year}-${formattedMonth}-${formattedDay}`;
  
  // Mostrar formulario
  editingShiftId = null;
  shiftEmployee.value = employee.id;
  shiftDate.value = dateString;
  shiftType.value = 'morning';
  shiftNotes.value = '';
  editShiftForm.style.display = 'block';
  editShiftForm.scrollIntoView({ behavior: 'smooth' });
});
      }
      
      row.appendChild(cell);
    }
    
    scheduleBody.appendChild(row);
  });
}

// Editar un turno existente
// Editar un turno existente
function editShift(shiftId) {
  editingShiftId = shiftId;
  
  const shift = currentShifts.find(s => s.id === shiftId);
  if (!shift) return;
  
  // Llenar el formulario
  shiftEmployee.value = shift.empleadoId;
  
  // Manejar correctamente la fecha
  const shiftDateTime = shift.fecha instanceof Date ? shift.fecha : shift.fecha.toDate();
  
  // Extraer año, mes y día
  const year = shiftDateTime.getFullYear();
  const month = (shiftDateTime.getMonth() + 1).toString().padStart(2, '0');
  const day = shiftDateTime.getDate().toString().padStart(2, '0');
  
  // Formato YYYY-MM-DD
  const dateStr = `${year}-${month}-${day}`;
  shiftDate.value = dateStr;
  
  shiftType.value = shift.tipo;
  shiftNotes.value = shift.notas || '';
  
  // Mostrar formulario
  editShiftForm.style.display = 'block';
  editShiftForm.scrollIntoView({ behavior: 'smooth' });
}

// Guardar un turno
function saveShift() {
  // Validar campos
  if (!shiftEmployee.value) {
    alert('Por favor selecciona un empleado');
    return;
  }
  
  if (!shiftDate.value) {
    alert('Por favor selecciona una fecha');
    return;
  }
  
  // Parseamos la fecha correctamente
  const [year, month, day] = shiftDate.value.split('-').map(num => parseInt(num));
  
  // Crear un objeto Date con la fecha seleccionada (sin tiempo)
  const selectedDate = new Date(year, month - 1, day, 12, 0, 0);
  
  // Preparar datos
  const shiftData = {
    empleadoId: shiftEmployee.value,
    fecha: selectedDate,
    tipo: shiftType.value,
    notas: shiftNotes.value.trim(),
    updatedAt: new Date(),
    updatedBy: currentUser.uid
  };
  
  // Si es un nuevo turno
  if (!editingShiftId) {
    shiftData.createdAt = new Date();
    shiftData.createdBy = currentUser.uid;
  }
  
  console.log('Guardando turno para la fecha:', selectedDate.toLocaleDateString());
  
  // Guardar en Firestore
  const savePromise = editingShiftId
    ? shiftsCollection.doc(editingShiftId).update(shiftData)
    : shiftsCollection.add(shiftData);
    
  savePromise
    .then(() => {
      // Ocultar formulario y recargar turnos
      editShiftForm.style.display = 'none';
      loadShifts();
    })
    .catch(error => {
      console.error('Error guardando turno:', error);
      alert('Error al guardar el turno: ' + error.message);
    });
}

// Exportar horarios a Excel
function exportSchedule() {
  // Crear una matriz para los datos
  const data = [];
  
  // Fila de encabezado con los días
  const headerRow = ['Empleado', 'Departamento', 'Hotel'];
  
  for (let i = 0; i < 7; i++) {
    const day = new Date(currentWeekStart);
    day.setDate(day.getDate() + i);
    
    const dayName = day.toLocaleDateString('es-ES', { weekday: 'long' });
    const dayNumber = day.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' });
    
    headerRow.push(`${dayName} ${dayNumber}`);
  }
  
  data.push(headerRow);
  
  // Agrupar turnos por empleado
  const shiftsByEmployee = {};
  
  currentEmployees.forEach(employee => {
    shiftsByEmployee[employee.id] = {
      employee,
      shifts: Array(7).fill(null)
    };
  });
  
  currentShifts.forEach(shift => {
    const shiftDate = shift.fecha instanceof Date ? shift.fecha : shift.fecha.toDate();
    const diffDays = Math.floor((shiftDate - currentWeekStart) / (24 * 60 * 60 * 1000));
    
    if (diffDays >= 0 && diffDays < 7 && shiftsByEmployee[shift.empleadoId]) {
      shiftsByEmployee[shift.empleadoId].shifts[diffDays] = shift;
    }
  });
  
  // Añadir filas para cada empleado
  Object.values(shiftsByEmployee).forEach(({ employee, shifts }) => {
    const row = [
      employee.nombre,
      employee.departamento,
      employee.hotel
    ];
    
    // Añadir turnos
    for (let i = 0; i < 7; i++) {
      const shift = shifts[i];
      if (shift) {
        let shiftText = '';
        switch (shift.tipo) {
          case 'morning': shiftText = 'Mañana (7-15h)'; break;
          case 'afternoon': shiftText = 'Tarde (15-23h)'; break;
          case 'night': shiftText = 'Noche (23-7h)'; break;
          case 'off': shiftText = 'Descanso'; break;
          case 'vacation': shiftText = 'Vacaciones'; break;
        }
        row.push(shiftText);
      } else {
        row.push('');
      }
    }
    
    data.push(row);
  });
  
  // Crear libro Excel
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(data);
  
  // Añadir hoja al libro
  XLSX.utils.book_append_sheet(wb, ws, 'Turnos');
  
  // Generar el archivo Excel
  const startDate = currentWeekStart.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' });
  const endDate = new Date(currentWeekStart);
  endDate.setDate(endDate.getDate() + 6);
  const endDateStr = endDate.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' });
  
  XLSX.writeFile(wb, `Turnos_${startDate}_${endDateStr}.xlsx`);
}

// Colección mock de empleados para demostración
function seedEmployeesData() {
  const mockEmployees = [
    { nombre: 'Sebas', departamento: 'mantenimiento', hotel: 'Wave' },
    { nombre: 'Juan', departamento: 'mantenimiento', hotel: 'Wave' },
    { nombre: 'Miguel', departamento: 'mantenimiento', hotel: 'Wave' },
    { nombre: 'Paco', departamento: 'mantenimiento', hotel: 'Wave' },
    { nombre: 'Toni', departamento: 'mantenimiento', hotel: 'Wave' },
    { nombre: 'Sergio', departamento: 'mantenimiento', hotel: 'Wave' },
    { nombre: 'Angus', departamento: 'mantenimiento', hotel: 'Wave' },
    { nombre: 'Pedro', departamento: 'mantenimiento', hotel: 'Wave' }
  ];

  // Comprobar si ya existen empleados
  return employeesCollection.get()
    .then(snapshot => {
      // Solo sembrar datos si no hay empleados
      if (snapshot.empty) {
        const batch = db.batch();
        
        mockEmployees.forEach(employee => {
          const docRef = employeesCollection.doc();
          batch.set(docRef, {
            ...employee,
            createdAt: new Date(),
            createdBy: currentUser.uid
          });
        });
        
        return batch.commit();
      }
      return null;
    })
    .catch(error => {
      console.error('Error sembrando datos de empleados:', error);
    });
}

// Exponer funciones al ámbito global
window.editShift = editShift;


// Exponer funciones al ámbito global para los botones inline
window.shareChemicalWhatsApp = shareChemicalWhatsApp;
window.deleteChemical = deleteChemical;

// Inicializar módulo de químicos cuando se carga
document.addEventListener('DOMContentLoaded', () => {
  // Inicializar lista de productos químicos
  if (chemicalProductsList) {
    initChemicalProductsList();
  }
});
      </script>

    </body>
</html>