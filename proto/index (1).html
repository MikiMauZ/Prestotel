<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Prestotel - Sistema de Gestión Hotelera</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f4f6f8;
      color: #333;
    }

    /* Estilos de Login */
    .login-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background-color: #f4f6f8;
      padding: 20px;
    }
    .login-box {
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 400px;
      padding: 30px;
    }
    .login-logo {
      text-align: center;
      margin-bottom: 30px;
    }
    .login-logo img {
      height: 60px;
    }
    .login-field {
      margin-bottom: 20px;
    }
    .login-field label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #555;
    }
    .login-field input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
    }
    .login-btn {
      width: 100%;
      background-color: #3b6aaf;
      color: white;
      border: none;
      padding: 12px;
      border-radius: 4px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .login-btn:hover {
      background-color: #325a96;
    }
    .login-error {
      color: #e74c3c;
      margin-top: 15px;
      text-align: center;
    }

    /* Estilos de la Topbar */
    .topbar {
      background-color: #f0f0f0;
      border-bottom: 1px solid #ddd;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0;
    }
    .menu-btn {
      padding: 15px;
      display: flex;
      align-items: center;
      color: #666;
      font-size: 1rem;
      cursor: pointer;
      border-right: 1px solid #ddd;
    }
    .menu-btn i {
      margin-left: 5px;
    }
    .logo {
      padding: 10px 15px;
      display: flex;
      align-items: center;
    }
    .logo-text {
      font-size: 1.2rem;
      font-weight: bold;
    }
    .logo-text span:first-child {
      color: #3b6aaf;
    }
    .logo-text span:last-child {
      color: #888;
    }
    .user-actions {
      display: flex;
    }
    .action-btn {
      width: 50px;
      height: 50px;
      display: flex;
      justify-content: center;
      align-items: center;
      color: #666;
      font-size: 1.1rem;
      border-left: 1px solid #ddd;
      cursor: pointer;
    }
    /* Estilos del Menú */
    .menu-container {
      position: fixed;
      top: 50px;
      left: 0;
      width: 100%;
      height: calc(100vh - 50px);
      background-color: #f0f0f0;
      z-index: 100;
      transform: translateX(-100%);
      transition: transform 0.3s;
      overflow-y: auto;
    }
    .menu-container.open {
      transform: translateX(0);
    }
    .menu-header {
      padding: 15px;
      color: #666;
      font-size: 1rem;
      border-bottom: 1px solid #ddd;
    }
    .menu-modules {
      padding: 0;
    }
    .module-item {
      display: flex;
      align-items: center;
      padding: 15px;
      border-bottom: 1px solid #ddd;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .module-item:hover {
      background-color: #e8e8e8;
    }
    .module-icon {
      width: 40px;
      height: 40px;
      background-color: #333;
      color: white;
      display: flex;
      justify-content: center;
      align-items: center;
      margin-right: 15px;
      font-size: 1.2rem;
    }
    .module-text {
      color: #555;
      font-size: 1rem;
    }

    /* Estilos de contenido principal */
    .content {
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }
    .content-header {
      margin-bottom: 20px;
    }
    .content-title {
      font-size: 1.5rem;
      font-weight: 500;
      color: #333;
      margin-bottom: 5px;
    }
    .content-subtitle {
      color: #777;
      font-size: 0.9rem;
    }

    /* Estilos de los formularios */
    .form-container {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      padding: 20px;
      margin-bottom: 20px;
    }
    .form-title {
      font-size: 1.1rem;
      font-weight: 500;
      margin-bottom: 15px;
      color: #333;
    }
    .form-row {
      display: flex;
      flex-wrap: wrap;
      margin: 0 -10px;
    }
    .form-group {
      padding: 0 10px;
      margin-bottom: 15px;
      flex: 1 0 100%;
    }
    @media (min-width: 768px) {
      .form-group.half {
        flex: 0 0 50%;
      }
      .form-group.third {
        flex: 0 0 33.33%;
      }
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: #555;
      font-size: 0.9rem;
    }
    .form-control {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 0.95rem;
    }
    textarea.form-control {
      min-height: 100px;
      resize: vertical;
    }
    .btn {
      background-color: #3b6aaf;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.95rem;
      transition: background-color 0.2s;
    }
    .btn:hover {
      background-color: #325a96;
    }
    .btn-danger {
      background-color: #e74c3c;
    }
    .btn-danger:hover {
      background-color: #c0392b;
    }
    .btn-warning {
      background-color: #f39c12;
    }
    .btn-warning:hover {
      background-color: #d35400;
    }
    .btn-success {
      background-color: #27ae60;
    }
    .btn-success:hover {
      background-color: #219653;
    }

    /* Estilos de las tablas y tarjetas */
    .data-container {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      overflow: hidden;
    }
    .filter-bar {
      padding: 15px;
      border-bottom: 1px solid #eee;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .filter-group {
      display: flex;
      align-items: center;
    }
    .filter-label {
      margin-right: 8px;
      font-size: 0.9rem;
      color: #555;
    }
    .filter-select {
      padding: 6px 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 0.9rem;
    }
    .card-container {
      padding: 15px;
    }
    .task-card {
      border: 1px solid #eee;
      border-radius: 6px;
      padding: 15px;
      margin-bottom: 15px;
      background-color: #fff;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    .task-card:last-child {
      margin-bottom: 0;
    }
    .task-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 10px;
    }
    .task-title {
      font-weight: 500;
      font-size: 1.1rem;
      color: #333;
      margin: 0;
    }
    .task-meta {
      display: flex;
      font-size: 0.85rem;
      margin-bottom: 5px;
    }
    .task-hotel, .task-area, .task-date {
      color: #666;
      margin-right: 15px;
    }
    .task-priority {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
      color: white;
      font-weight: 500;
    }
    .priority-alta {
      background-color: #e74c3c;
    }
    .priority-media {
      background-color: #f39c12;
    }
    .priority-baja {
      background-color: #27ae60;
    }
    .task-description {
      color: #555;
      font-size: 0.95rem;
      margin-bottom: 15px;
    }
    .task-cost {
      color: #3b6aaf;
      font-weight: 500;
      font-size: 1rem;
      margin-bottom: 15px;
    }
    .task-actions {
      display: flex;
      gap: 10px;
    }

    /* Estilos para stock y pedidos (inicialmente ocultos) */
    .module-content {
      display: none;
    }
    .module-content.active {
      display: block;
    }

    /* Stock específico */
    .stock-item {
      display: flex;
      flex-wrap: wrap;
      border-bottom: 1px solid #eee;
      padding: 10px 0;
    }
    .stock-item:last-child {
      border-bottom: none;
    }
    .stock-name {
      flex: 2;
      padding: 5px;
      font-weight: 500;
    }
    .stock-quantity {
      flex: 1;
      padding: 5px;
      text-align: center;
    }
    .stock-actions {
      flex: 1;
      padding: 5px;
      text-align: right;
    }
    .stock-level-low {
      color: #e74c3c;
    }
    .stock-level-medium {
      color: #f39c12;
    }
    .stock-level-good {
      color: #27ae60;
    }

    /* Pedidos específico */
    .order-status {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
      color: white;
      font-weight: 500;
    }
    .status-pendiente {
      background-color: #f39c12;
    }
    .status-aprobado {
      background-color: #3498db;
    }
    .status-completado {
      background-color: #27ae60;
    }
    .status-rechazado {
      background-color: #e74c3c;
    }

    /* Utilidades */
    .text-right {
      text-align: right;
    }
    .spacer {
      flex: 1;
    }
    .hidden {
      display: none;
    }
    .admin-only {
      display: none;
    }
    .is-admin .admin-only {
      display: block;
    }
    </style>
    </head>
    <body>
      <!-- Pantalla de Login -->
      <div id="loginScreen" class="login-container">
        <div class="login-box">
          <div class="login-logo">
            <div class="logo-text">
              <span>Prestotel</span><span> HOTEL</span>
            </div>
          </div>
          <div class="login-field">
            <label for="email">Correo electrónico</label>
            <input type="email" id="email" placeholder="correo@ejemplo.com">
          </div>
          <div class="login-field">
            <label for="password">Contraseña</label>
            <input type="password" id="password" placeholder="Contraseña">
          </div>
          <button id="loginBtn" class="login-btn">Iniciar Sesión</button>
          <div id="loginError" class="login-error"></div>
        </div>
      </div>

      <!-- Aplicación Principal (inicialmente oculta) -->
      <div id="appScreen" class="hidden">
        <!-- Barra superior -->
        <div class="topbar">
          <div class="menu-btn" id="menuBtn">
            Menú <i class="fas fa-chevron-right"></i>
          </div>
          <div class="logo">
            <div class="logo-text">
              <span>Prestotel</span><span> HOTEL</span>
            </div>
          </div>
          <div class="user-actions">
            <div class="action-btn" aria-label="Mensajes">
              <i class="fas fa-envelope"></i>
            </div>
            <div class="action-btn" aria-label="Ayuda">
              <i class="fas fa-question-circle"></i>
            </div>
            <div class="action-btn" id="userBtn" aria-label="Usuario">
              <i class="fas fa-user"></i>
            </div>
          </div>
        </div>

        <!-- Menú lateral -->
        <div class="menu-container" id="menuContainer">
          <div class="menu-header">Módulos disponibles</div>
          <div class="menu-modules">
            <div class="module-item" data-module="mejoras">
              <div class="module-icon"><i class="fas fa-tasks"></i></div>
              <div class="module-text">Mejoras de Invierno</div>
            </div>
            <div class="module-item" data-module="stock">
              <div class="module-icon"><i class="fas fa-boxes"></i></div>
              <div class="module-text">Inventario / Stock</div>
            </div>
            <div class="module-item" data-module="pedidos">
              <div class="module-icon"><i class="fas fa-shopping-cart"></i></div>
              <div class="module-text">Pedidos</div>
            </div>
            <div class="module-item" id="logoutBtn">
              <div class="module-icon" style="background-color: #e74c3c;">
                <i class="fas fa-sign-out-alt"></i>
              </div>
              <div class="module-text">Cerrar Sesión</div>
            </div>
          </div>
        </div>

        <!-- Contenido principal -->
        <div class="content">

          <!-- Módulo de Mejoras -->
          <div id="mejorasModule" class="module-content active">
            <div class="content-header">
              <h1 class="content-title">Mejoras de Invierno</h1>
              <div class="content-subtitle">Gestión de tareas de mejora para el cierre de temporada</div>
            </div>

            <!-- Formulario de nueva tarea -->
            <div class="form-container">
              <h2 class="form-title">Nueva tarea de mejora</h2>
              <div class="form-row">
                <div class="form-group">
                  <label for="taskTitle">Título</label>
                  <input type="text" id="taskTitle" class="form-control" placeholder="Título de la tarea">
                </div>
              </div>
              <div class="form-row">
                <div class="form-group half">
                  <label for="taskHotel">Hotel</label>
                  <select id="taskHotel" class="form-control">
                    <option value="Wave">Wave</option>
                    <option value="Sky">Sky</option>
                    <option value="Palm">Palm</option>
                  </select>
                </div>
                <div class="form-group half">
                  <label for="taskArea">Área</label>
                  <select id="taskArea" class="form-control">
                    <option value="Recepción">Recepción</option>
                    <option value="Habitaciones">Habitaciones</option>
                    <option value="Restaurante">Restaurante</option>
                    <option value="Cocina">Cocina</option>
                    <option value="Exterior">Exterior</option>
                    <option value="Piscina">Piscina</option>
                    <option value="Baños">Baños</option>
                    <option value="Zonas Técnicas">Zonas Técnicas</option>
                    <option value="Gimnasio">Gimnasio</option>
                    <option value="Bar">Bar</option>
                    <option value="Zonas Comunes">Zonas Comunes</option>
                    <option value="Sótano">Sótano</option>
                    <option value="Otra">Otra</option>
                  </select>
                </div>
              </div>
              <div class="form-row">
                <div class="form-group half">
                  <label for="taskPriority">Prioridad</label>
                  <select id="taskPriority" class="form-control">
                    <option value="Alta">Alta</option>
                    <option value="Media" selected>Media</option>
                    <option value="Baja">Baja</option>
                  </select>
                </div>
                <div class="form-group half">
                  <label for="taskCost">Coste estimado (€)</label>
                  <input type="number" id="taskCost" class="form-control" placeholder="0">
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label for="taskDescription">Descripción</label>
                  <textarea id="taskDescription" class="form-control" placeholder="Describe la tarea..."></textarea>
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <button id="saveTask" class="btn">Guardar Tarea</button>
                </div>
              </div>
            </div>

            <!-- Lista de tareas -->
            <div class="data-container">
              <div class="filter-bar">
                <div class="filter-group">
                  <span class="filter-label">Hotel:</span>
                  <select id="filterHotel" class="filter-select">
                    <option value="">Todos</option>
                    <option value="Wave">Wave</option>
                    <option value="Sky">Sky</option>
                    <option value="Palm">Palm</option>
                  </select>
                </div>
                <div class="filter-group">
                  <span class="filter-label">Área:</span>
                  <select id="filterArea" class="filter-select">
                    <option value="">Todas</option>
                    <option value="Recepción">Recepción</option>
                    <option value="Habitaciones">Habitaciones</option>
                    <option value="Restaurante">Restaurante</option>
                    <option value="Cocina">Cocina</option>
                    <option value="Exterior">Exterior</option>
                    <option value="Piscina">Piscina</option>
                    <option value="Baños">Baños</option>
                    <option value="Zonas Técnicas">Zonas Técnicas</option>
                    <option value="Gimnasio">Gimnasio</option>
                    <option value="Bar">Bar</option>
                    <option value="Zonas Comunes">Zonas Comunes</option>
                    <option value="Sótano">Sótano</option>
                    <option value="Otra">Otra</option>
                  </select>
                </div>
                <div class="filter-group">
                  <span class="filter-label">Prioridad:</span>
                  <select id="filterPriority" class="filter-select">
                    <option value="">Todas</option>
                    <option value="Alta">Alta</option>
                    <option value="Media">Media</option>
                    <option value="Baja">Baja</option>
                  </select>
                </div>
                <div class="spacer"></div>
                <button id="clearFilters" class="btn">Limpiar</button>
                <button id="exportExcel" class="btn btn-success">
                  <i class="fas fa-file-excel"></i> Exportar
                </button>
              </div>
              <div id="taskContainer" class="card-container">
                <!-- Las tareas se cargarán aquí dinámicamente -->
              </div>
            </div>
          </div>
          <!-- Módulo de Stock/Inventario -->
          <div id="stockModule" class="module-content">
            <div class="content-header">
              <h1 class="content-title">Inventario / Stock</h1>
              <div class="content-subtitle">Control de stock y materiales</div>
            </div>

            <!-- Formulario de nuevo ítem de stock -->
            <div class="form-container">
              <h2 class="form-title">Nuevo ítem de inventario</h2>
              <div class="form-row">
                <div class="form-group half">
                  <label for="stockName">Nombre del producto</label>
                  <input type="text" id="stockName" class="form-control" placeholder="Nombre del producto">
                </div>
                <div class="form-group half">
                  <label for="stockCategory">Categoría</label>
                  <select id="stockCategory" class="form-control">
                    <option value="Limpieza">Limpieza</option>
                    <option value="Mantenimiento">Mantenimiento</option>
                    <option value="Cocina">Cocina</option>
                    <option value="Habitaciones">Habitaciones</option>
                    <option value="Piscina">Piscina</option>
                    <option value="Oficina">Oficina</option>
                    <option value="Otra">Otra</option>
                  </select>
                </div>
              </div>
              <div class="form-row">
                <div class="form-group third">
                  <label for="stockQuantity">Cantidad</label>
                  <input type="number" id="stockQuantity" class="form-control" placeholder="0">
                </div>
                <div class="form-group third">
                  <label for="stockMinimum">Cantidad mínima</label>
                  <input type="number" id="stockMinimum" class="form-control" placeholder="0">
                </div>
                <div class="form-group third">
                  <label for="stockUnit">Unidad</label>
                  <select id="stockUnit" class="form-control">
                    <option value="Unidades">Unidades</option>
                    <option value="Cajas">Cajas</option>
                    <option value="Kg">Kg</option>
                    <option value="Litros">Litros</option>
                    <option value="Metros">Metros</option>
                    <option value="Paquetes">Paquetes</option>
                  </select>
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label for="stockNotes">Notas</label>
                  <textarea id="stockNotes" class="form-control" placeholder="Notas adicionales..."></textarea>
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <button id="saveStock" class="btn">Guardar Producto</button>
                </div>
              </div>
            </div>

            <!-- Lista de stock -->
            <div class="data-container">
              <div class="filter-bar">
                <div class="filter-group">
                  <span class="filter-label">Categoría:</span>
                  <select id="filterStockCategory" class="filter-select">
                    <option value="">Todas</option>
                    <option value="Limpieza">Limpieza</option>
                    <option value="Mantenimiento">Mantenimiento</option>
                    <option value="Cocina">Cocina</option>
                    <option value="Habitaciones">Habitaciones</option>
                    <option value="Piscina">Piscina</option>
                    <option value="Oficina">Oficina</option>
                    <option value="Otra">Otra</option>
                  </select>
                </div>
                <div class="filter-group">
                  <span class="filter-label">Stock:</span>
                  <select id="filterStockLevel" class="filter-select">
                    <option value="">Todos</option>
                    <option value="low">Bajo mínimo</option>
                    <option value="medium">Regular</option>
                    <option value="good">Adecuado</option>
                  </select>
                </div>
                <div class="spacer"></div>
                <button id="clearStockFilters" class="btn">Limpiar</button>
                <button id="exportStockExcel" class="btn btn-success">
                  <i class="fas fa-file-excel"></i> Exportar
                </button>
              </div>
              <div id="stockContainer" class="card-container">
                <!-- Los ítems de stock se cargarán aquí dinámicamente -->
              </div>
            </div>
          </div>

          <!-- Módulo de Pedidos -->
          <div id="pedidosModule" class="module-content">
            <div class="content-header">
              <h1 class="content-title">Pedidos</h1>
              <div class="content-subtitle">Gestión de pedidos a proveedores</div>
            </div>

            <!-- Formulario de nuevo pedido -->
            <div class="form-container">
              <h2 class="form-title">Nuevo pedido</h2>
              <div class="form-row">
                <div class="form-group half">
                  <label for="orderTitle">Título del pedido</label>
                  <input type="text" id="orderTitle" class="form-control" placeholder="Título del pedido">
                </div>
                <div class="form-group half">
                  <label for="orderSupplier">Proveedor</label>
                  <input type="text" id="orderSupplier" class="form-control" placeholder="Nombre del proveedor">
                </div>
              </div>
              <div class="form-row">
                <div class="form-group half">
                  <label for="orderDate">Fecha necesaria</label>
                  <input type="date" id="orderDate" class="form-control">
                </div>
                <div class="form-group half">
                  <label for="orderAmount">Importe estimado (€)</label>
                  <input type="number" id="orderAmount" class="form-control" placeholder="0">
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label for="orderItems">Elementos a pedir</label>
                  <textarea id="orderItems" class="form-control" placeholder="Detalle de los elementos a pedir..."></textarea>
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <button id="saveOrder" class="btn">Guardar Pedido</button>
                </div>
              </div>
            </div>

            <!-- Lista de pedidos -->
            <div class="data-container">
              <div class="filter-bar">
                <div class="filter-group">
                  <span class="filter-label">Estado:</span>
                  <select id="filterOrderStatus" class="filter-select">
                    <option value="">Todos</option>
                    <option value="Pendiente">Pendiente</option>
                    <option value="Aprobado">Aprobado</option>
                    <option value="Completado">Completado</option>
                    <option value="Rechazado">Rechazado</option>
                  </select>
                </div>
                <div class="filter-group">
                  <span class="filter-label">Proveedor:</span>
                  <select id="filterOrderSupplier" class="filter-select">
                    <option value="">Todos</option>
                    <!-- Se llenará dinámicamente -->
                  </select>
                </div>
                <div class="spacer"></div>
                <button id="clearOrderFilters" class="btn">Limpiar</button>
                <button id="exportOrderExcel" class="btn btn-success">
                  <i class="fas fa-file-excel"></i> Exportar
                </button>
              </div>
              <div id="orderContainer" class="card-container">
                <!-- Los pedidos se cargarán aquí dinámicamente -->
              </div>
            </div>
          </div> <!-- Fin del módulo de pedidos -->
          </div> <!-- Fin del contenido principal -->
          </div> <!-- Fin del appScreen -->
      <!-- Código JavaScript -->
      <script>
        // Configuración de Firebase
        const firebaseConfig = {
          apiKey: "AIzaSyBR8e4G0tEpXnUwNpxzM3nvklsbRY1zFI0",
          authDomain: "tareas-invierno.firebaseapp.com",
          projectId: "tareas-invierno",
          storageBucket: "tareas-invierno.appspot.com",
          messagingSenderId: "253712224629",
          appId: "1:253712224629:web:f11abaa587d3816e5a433c",
          measurementId: "G-4Z1W4C05LP"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Colecciones de Firestore
        const tasksCollection = db.collection('tasks');
        const stockCollection = db.collection('stock');
        const ordersCollection = db.collection('orders');
        const usersCollection = db.collection('users');

        // Variables globales
        let currentUser = null;
        let isAdmin = false;
        let currentTaskId = null;
        let currentStockId = null;
        let currentOrderId = null;

        // Elementos DOM de autenticación
        const loginScreen = document.getElementById('loginScreen');
        const appScreen = document.getElementById('appScreen');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const loginBtn = document.getElementById('loginBtn');
        const loginError = document.getElementById('loginError');
        const logoutBtn = document.getElementById('logoutBtn');

        // Elementos DOM de navegación
        const menuBtn = document.getElementById('menuBtn');
        const menuContainer = document.getElementById('menuContainer');
        const moduleItems = document.querySelectorAll('.module-item[data-module]');
        const moduleContents = document.querySelectorAll('.module-content');

        // Manejo de login
        loginBtn.addEventListener('click', () => {
          const email = emailInput.value.trim();
          const password = passwordInput.value;

          if (!email || !password) {
            loginError.textContent = 'Por favor introduce email y contraseña';
            return;
          }

          loginBtn.disabled = true;
          loginBtn.textContent = 'Iniciando sesión...';

          auth.signInWithEmailAndPassword(email, password)
            .catch(error => {
              console.error('Error de autenticación:', error);
              let errorMessage = 'Error al iniciar sesión';
              if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                errorMessage = 'Credenciales incorrectas';
              } else if (error.code === 'auth/invalid-email') {
                errorMessage = 'Formato de email inválido';
              } else if (error.code === 'auth/too-many-requests') {
                errorMessage = 'Demasiados intentos. Intenta más tarde';
              }
              loginError.textContent = errorMessage;
              loginBtn.disabled = false;
              loginBtn.textContent = 'Iniciar Sesión';
            });
        });

        // Escuchar cambios de sesión
        auth.onAuthStateChanged(user => {
          if (user) {
            currentUser = user;

            usersCollection.doc(user.uid).get().then(doc => {
              if (doc.exists && doc.data().role === 'admin') {
                isAdmin = true;
                document.body.classList.add('is-admin');
              } else {
                isAdmin = false;
                document.body.classList.remove('is-admin');
              }

              loginScreen.classList.add('hidden');
              appScreen.classList.remove('hidden');

              loadTasks();
              loadStock();
              loadOrders();
            }).catch(error => {
              console.error('Error al verificar rol:', error);
            });

          } else {
            currentUser = null;
            isAdmin = false;
            document.body.classList.remove('is-admin');
            loginScreen.classList.remove('hidden');
            appScreen.classList.add('hidden');
            emailInput.value = '';
            passwordInput.value = '';
            loginBtn.disabled = false;
            loginBtn.textContent = 'Iniciar Sesión';
            loginError.textContent = '';
          }
        });

        // Cerrar sesión
        logoutBtn.addEventListener('click', () => {
          auth.signOut().catch(error => {
            console.error('Error al cerrar sesión:', error);
          });
        });

        // Menú desplegable
        menuBtn.addEventListener('click', () => {
          menuContainer.classList.toggle('open');
          const icon = menuBtn.querySelector('i');
          icon.classList.toggle('fa-chevron-right');
          icon.classList.toggle('fa-chevron-left');
        });

        // Cambiar módulo activo
        moduleItems.forEach(item => {
          item.addEventListener('click', () => {
            const moduleId = item.getAttribute('data-module');
            if (moduleId) {
              moduleContents.forEach(content => content.classList.remove('active'));
              document.getElementById(`${moduleId}Module`).classList.add('active');
              menuContainer.classList.remove('open');
              menuBtn.querySelector('i').classList.remove('fa-chevron-left');
              menuBtn.querySelector('i').classList.add('fa-chevron-right');
            }
          });
        });

        // Cerrar menú al hacer clic fuera
        document.addEventListener('click', (e) => {
          if (menuContainer.classList.contains('open') && !menuBtn.contains(e.target)) {
            menuContainer.classList.remove('open');
            menuBtn.querySelector('i').classList.remove('fa-chevron-left');
            menuBtn.querySelector('i').classList.add('fa-chevron-right');
          }
        });

        // Utilidades generales
        function formatDate(timestamp) {
          if (!timestamp) return 'N/D';
          try {
            const date = timestamp instanceof Date ? timestamp : timestamp.toDate();
            return date.toLocaleDateString('es-ES', {
              day: '2-digit',
              month: '2-digit',
              year: 'numeric'
            });
          } catch (e) {
            return 'Inválida';
          }
        }

        function sanitizeHTML(text) {
          if (!text) return '';
          return text
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
        }
      </script>

      <script>
        // -----------------------------
        // INICIALIZACIÓN Y UTILIDADES
        // -----------------------------
        document.addEventListener('DOMContentLoaded', () => {
          if (auth.currentUser) {
            loginScreen.classList.add('hidden');
            appScreen.classList.remove('hidden');
          } else {
            loginScreen.classList.remove('hidden');
            appScreen.classList.add('hidden');
          }

          const today = new Date().toISOString().split('T')[0];
          const orderDate = document.getElementById('orderDate');
          if (orderDate) {
            orderDate.setAttribute('min', today);
          }
        });

        // Gestión de errores general
        window.addEventListener('error', (event) => {
          console.error('Error general:', event.error);
          alert('Ha ocurrido un error inesperado. Contacta con soporte técnico.');
        });

          function loadTasks() {
              tasksCollection.orderBy('createdAt', 'desc').get().then(snapshot => {
                  const tasks = [];
                  snapshot.forEach(doc => tasks.push({ id: doc.id, ...doc.data() }));
                  applyTaskFilters(tasks);
              }).catch(error => {
                  console.error('Error al cargar tareas:', error);
                  alert('Error al cargar las tareas');
              });
          }

          function applyTaskFilters(tasks) {
              const hotel = document.getElementById('filterHotel').value;
              const area = document.getElementById('filterArea').value;
              const priority = document.getElementById('filterPriority').value;
              const filtered = tasks.filter(t =>
                  (!hotel || t.hotel === hotel) &&
                  (!area || t.area === area) &&
                  (!priority || t.priority === priority)
              );
              renderTasks(filtered);
          }

          function renderTasks(tasks) {
              const container = document.getElementById('taskContainer');
              container.innerHTML = '';
              if (tasks.length === 0) {
                  container.innerHTML = '<p class="text-center">No hay tareas</p>';
                  return;
              }

              tasks.forEach(task => {
                  const card = document.createElement('div');
                  card.className = 'task-card';
                  const priorityClass = `priority-${task.priority.toLowerCase()}`;
                  card.innerHTML = `
      <div class="task-header">
        <h3 class="task-title">${sanitizeHTML(task.title)}</h3>
        <span class="task-priority ${priorityClass}">${sanitizeHTML(task.priority)}</span>
      </div>
      <div class="task-meta">
        <div class="task-hotel"><i class="fas fa-hotel"></i> ${sanitizeHTML(task.hotel)}</div>
        <div class="task-area"><i class="fas fa-map-marker-alt"></i> ${sanitizeHTML(task.area)}</div>
        <div class="task-date"><i class="fas fa-calendar-alt"></i> ${formatDate(task.createdAt)}</div>
      </div>
      <div class="task-description">${sanitizeHTML(task.description || '')}</div>
      <div class="task-cost"><i class="fas fa-euro-sign"></i> ${task.cost.toFixed(2)}€</div>
      <div class="task-actions">
        <button class="btn btn-warning" onclick="editTask('${task.id}')"><i class="fas fa-edit"></i> Editar</button>
        <button class="btn btn-danger" onclick="deleteTask('${task.id}')"><i class="fas fa-trash"></i> Eliminar</button>
      </div>`;
                  container.appendChild(card);
              });
          }

          function editTask(id) {
              tasksCollection.doc(id).get().then(doc => {
                  if (!doc.exists) return alert('Tarea no encontrada');
                  const t = doc.data();
                  document.getElementById('taskTitle').value = t.title;
                  document.getElementById('taskHotel').value = t.hotel;
                  document.getElementById('taskArea').value = t.area;
                  document.getElementById('taskPriority').value = t.priority;
                  document.getElementById('taskCost').value = t.cost;
                  document.getElementById('taskDescription').value = t.description;
                  currentTaskId = id;
                  document.getElementById('saveTask').textContent = 'Actualizar Tarea';
              });
          }

          function deleteTask(id) {
              if (!confirm('¿Eliminar esta tarea?')) return;
              tasksCollection.doc(id).delete().then(() => {
                  if (currentTaskId === id) resetTaskForm();
                  loadTasks();
              });
          }

          // -----------------------------
          // MÓDULO: STOCK
          // -----------------------------
          function loadStock() {
              stockCollection.orderBy('name').get().then(snapshot => {
                  const items = [];
                  snapshot.forEach(doc => items.push({ id: doc.id, ...doc.data() }));
                  applyStockFilters(items);
              });
          }

          function applyStockFilters(items) {
              const cat = document.getElementById('filterStockCategory').value;
              const level = document.getElementById('filterStockLevel').value;
              const filtered = items.filter(item => {
                  const stockLevel = getStockLevel(item.quantity, item.minimum).level;
                  return (!cat || item.category === cat) && (!level || stockLevel === level);
              });
              renderStock(filtered);
          }

          function renderStock(items) {
              const container = document.getElementById('stockContainer');
              container.innerHTML = '';
              if (items.length === 0) {
                  container.innerHTML = '<p class="text-center">Sin productos</p>';
                  return;
              }

              items.forEach(item => {
                  const stockLevel = getStockLevel(item.quantity, item.minimum);
                  const div = document.createElement('div');
                  div.className = 'stock-item';
                  div.innerHTML = `
      <div class="stock-name">
        <div>${sanitizeHTML(item.name)}</div>
        <div style="font-size: 0.85rem; color: #666;"><i class="fas fa-tag"></i> ${sanitizeHTML(item.category)}</div>
      </div>
      <div class="stock-quantity">
        <div class="${stockLevel.class}"><strong>${item.quantity} ${item.unit}</strong></div>
        <div style="font-size: 0.8rem;">${stockLevel.text} (Mín: ${item.minimum})</div>
      </div>
      <div class="stock-actions">
        <button class="btn btn-sm btn-warning" onclick="editStock('${item.id}')"><i class="fas fa-edit"></i></button>
        <button class="btn btn-sm btn-danger" onclick="deleteStock('${item.id}')"><i class="fas fa-trash"></i></button>
      </div>`;
                  container.appendChild(div);
              });
          }

          function getStockLevel(q, m) {
              if (q <= 0) return { level: 'low', text: 'Agotado', class: 'stock-level-low' };
              if (q < m) return { level: 'low', text: 'Bajo mínimo', class: 'stock-level-low' };
              if (q < m * 2) return { level: 'medium', text: 'Regular', class: 'stock-level-medium' };
              return { level: 'good', text: 'Adecuado', class: 'stock-level-good' };
          }

          function editStock(id) {
              stockCollection.doc(id).get().then(doc => {
                  const item = doc.data();
                  document.getElementById('stockName').value = item.name;
                  document.getElementById('stockCategory').value = item.category;
                  document.getElementById('stockQuantity').value = item.quantity;
                  document.getElementById('stockMinimum').value = item.minimum;
                  document.getElementById('stockUnit').value = item.unit;
                  document.getElementById('stockNotes').value = item.notes || '';
                  currentStockId = id;
                  document.getElementById('saveStock').textContent = 'Actualizar Producto';
              });
          }

          function deleteStock(id) {
              if (!confirm('¿Eliminar producto?')) return;
              stockCollection.doc(id).delete().then(() => {
                  if (currentStockId === id) resetStockForm();
                  loadStock();
              });
          }

          // -----------------------------
          // MÓDULO: PEDIDOS
          // -----------------------------
          function loadOrders() {
              ordersCollection.orderBy('createdAt', 'desc').get().then(snapshot => {
                  const orders = [];
                  const suppliers = new Set();
                  snapshot.forEach(doc => {
                      const o = { id: doc.id, ...doc.data() };
                      orders.push(o);
                      if (o.supplier) suppliers.add(o.supplier);
                  });
                  updateSupplierFilter(suppliers);
                  applyOrderFilters(orders);
              });
          }

          function updateSupplierFilter(suppliers) {
              const select = document.getElementById('filterOrderSupplier');
              const value = select.value;
              while (select.options.length > 1) select.remove(1);
              [...suppliers].forEach(s => {
                  const opt = document.createElement('option');
                  opt.value = s;
                  opt.textContent = s;
                  select.appendChild(opt);
              });
              select.value = value;
          }

          function applyOrderFilters(orders) {
              const status = document.getElementById('filterOrderStatus').value;
              const supplier = document.getElementById('filterOrderSupplier').value;
              const filtered = orders.filter(o =>
                  (!status || o.status === status) &&
                  (!supplier || o.supplier === supplier)
              );
              renderOrders(filtered);
          }

          function renderOrders(orders) {
              const container = document.getElementById('orderContainer');
              container.innerHTML = '';
              if (orders.length === 0) {
                  container.innerHTML = '<p class="text-center">Sin pedidos</p>';
                  return;
              }

              orders.forEach(order => {
                  const div = document.createElement('div');
                  div.className = 'task-card';
                  const statusClass = `status-${(order.status || 'pendiente').toLowerCase()}`;
                  div.innerHTML = `
      <div class="task-header">
        <h3 class="task-title">${sanitizeHTML(order.title)}</h3>
        <span class="order-status ${statusClass}">${sanitizeHTML(order.status || 'Pendiente')}</span>
      </div>
      <div class="task-meta">
        <div><i class="fas fa-building"></i> ${sanitizeHTML(order.supplier)}</div>
        <div><i class="fas fa-calendar-alt"></i> ${order.date ? formatDate(order.date) : 'Sin fecha'}</div>
      </div>
      <div class="task-description">${sanitizeHTML(order.items || '')}</div>
      <div class="task-cost"><i class="fas fa-euro-sign"></i> ${order.amount.toFixed(2)}€</div>
      <div class="task-actions">
        <button class="btn btn-warning" onclick="editOrder('${order.id}')"><i class="fas fa-edit"></i> Editar</button>
        <button class="btn btn-danger" onclick="deleteOrder('${order.id}')"><i class="fas fa-trash"></i> Eliminar</button>
        ${isAdmin ? `
          <button class="btn btn-success" onclick="updateOrderStatus('${order.id}', 'Aprobado')" ${order.status === 'Aprobado' ? 'disabled' : ''}><i class="fas fa-check"></i> Aprobar</button>
          <button class="btn btn-danger" onclick="updateOrderStatus('${order.id}', 'Rechazado')" ${order.status === 'Rechazado' ? 'disabled' : ''}><i class="fas fa-times"></i> Rechazar</button>
        ` : ''}
      </div>`;
                  container.appendChild(div);
              });
          }

          function editOrder(id) {
              ordersCollection.doc(id).get().then(doc => {
                  const o = doc.data();
                  document.getElementById('orderTitle').value = o.title;
                  document.getElementById('orderSupplier').value = o.supplier;
                  if (o.date && o.date.toDate) {
                      const d = o.date.toDate();
                      document.getElementById('orderDate').value = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
                  }
                  document.getElementById('orderAmount').value = o.amount;
                  document.getElementById('orderItems').value = o.items;
                  currentOrderId = id;
                  document.getElementById('saveOrder').textContent = 'Actualizar Pedido';
              });
          }

          function deleteOrder(id) {
              if (!confirm('¿Eliminar pedido?')) return;
              ordersCollection.doc(id).delete().then(() => {
                  if (currentOrderId === id) resetOrderForm();
                  loadOrders();
              });
          }

          function updateOrderStatus(id, status) {
              if (!isAdmin) return;
              ordersCollection.doc(id).update({
                  status,
                  updatedAt: new Date(),
                  updatedBy: currentUser.uid,
                  updatedByEmail: currentUser.email
              }).then(() => loadOrders());
          }


        // Aquí debes continuar añadiendo:
        // - loadTasks(), saveTask(), renderTasks(), editTask(), deleteTask()
        // - loadStock(), saveStock(), renderStock(), editStock(), deleteStock()
        // - loadOrders(), saveOrder(), renderOrders(), editOrder(), deleteOrder()

        // NOTA: Ya escribiste estas funciones en tu código original, por lo que aquí puedes simplemente llamarlas si usas módulos separados
      </script>
      </body>
      </html>
      

